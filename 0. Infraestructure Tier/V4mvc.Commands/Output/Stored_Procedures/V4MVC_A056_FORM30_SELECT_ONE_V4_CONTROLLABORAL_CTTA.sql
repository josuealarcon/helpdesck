CREATE PROCEDURE [dbo].[V4MVC_A056_FORM30_SELECT_ONE_V4_CONTROLLABORAL_CTTA]
(
  @ID_DOC			INT
 ,@IDEMPRESA		NVARCHAR(10)
 ,@CERTIFICADO_ID	INT
) AS
BEGIN
	SELECT
		 PERIODO,
		 EMPRESA,
		 ID_CERTIFICADO,
		 REGION,
		 INSPECCION,
		 ANIO,
		 CLAVE,
		 CERTIFICADO,
		 VIGENCIA,
		 MULT_NEJ,
		 MULT_EJ,
		 SANC_6M,
		 SANC_12M,
		 DP_NRO,
		 DP_MTO_UTM,
		 DP_MTO_PESO,
		 RM_NRO,
		 RM_MTO_PESO,
		 ID,
		 VALIDADO,
		 OBSERVACION,
		 COALESCE(
					(
						SELECT
							TOP 1
							E.ACRONIMO
						FROM ENTERPRISE E
						WHERE E.IDEMPRESA = @IDEMPRESA
					), ''
				) AS ACRO_EMPRESA,
		 [dbo].[V4MVC_FSTR_RUT](@IDEMPRESA) AS STRUT_EMPRESA,
		 COALESCE(
			(
				SELECT
					TOP 1
						DD.ID_DISPUTA
				FROM DOCS_DISPUTA_CLABORAL DD
				WHERE
					DD.EMPRESA = A056_FORM30.EMPRESA AND
					DD.PERIODO = A056_FORM30.PERIODO AND
					DD.ID_DOC = @ID_DOC AND
					DD.ID = A056_FORM30.ID
				ORDER BY DD.ID_DISPUTA DESC
			), -1
		 ) AS DISPUTA_ID,
		 IIF(EXISTS(
				SELECT * 
				FROM DOCS_DISPUTA_CLABORAL DD
				WHERE
					DD.EMPRESA = A056_FORM30.EMPRESA AND
					DD.PERIODO = A056_FORM30.PERIODO AND
					DD.ID_DOC = @ID_DOC AND
					DD.ID = A056_FORM30.ID
				ORDER BY DD.ID_DISPUTA DESC
				OFFSET 0 ROWS
		 ), 1 , 0) AS DISPUTA_EXISTE,
		 COALESCE(
			(
				SELECT
					TOP 1
					ARCHIVO
				FROM ARCHIVOS A
				WHERE A.ID = A056_FORM30.ID
			), NULL
		 ) AS ADJUNTO_CONTENIDO,
		 COALESCE(
			(
				SELECT
					TOP 1
					TIPOCONTENIDO
				FROM ARCHIVOS A
				WHERE A.ID = A056_FORM30.ID
			), NULL
		 ) AS ADJUNTO_TIPOCONTENIDO,
		 COALESCE(
			(
				SELECT
					TOP 1
					NOMBRE
				FROM ARCHIVOS A
				WHERE A.ID = A056_FORM30.ID
			), NULL
		 ) AS ADJUNTO_NOMBRE		
	FROM A056_FORM30
	WHERE
		EMPRESA = @IDEMPRESA AND
		ID_CERTIFICADO = @CERTIFICADO_ID
END
