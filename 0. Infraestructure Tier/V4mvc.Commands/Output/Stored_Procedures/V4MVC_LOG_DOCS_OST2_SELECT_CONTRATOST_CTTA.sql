CREATE PROCEDURE [dbo].[V4MVC_LOG_DOCS_OST2_SELECT_CONTRATOST_CTTA]
(
 @NROOST	NVARCHAR(50),
 @MADRE		NVARCHAR(10),
 @IDEMPRESA NVARCHAR(10),
 @NIVEL		SMALLINT,
 @ID_DOC	SMALLINT
) AS
BEGIN
	SELECT
		SS.VALIDADO,
		SS.IDVAL,
		SS.ARCHIVOVAL,
		SS.DOC,
		SS.CERTUSUARIO,
		(CASE
			WHEN SS.CERTUSUARIO IS NOT NULL THEN (
													COALESCE(
														(
															SELECT
																CONCAT(W.NOMBRES, ' ', W.APELLIDOS)
															FROM WORKERS W
															WHERE W.RUT = SS.CERTUSUARIO
														), ''
													)
			)
			ELSE '' END
		) AS VALIDADOR_FNOMBRES,
		SS.OBSFASE1,
		SS.ARCHIVO_FASE1,
		SS.IDARCHIVO_FASE1,
		SS.FECHAFASE_1,
		SS.HORAFASE_1,
		SS.FASE
	FROM
	(
		SELECT
			L.VALIDADO_ADMINOST AS VALIDADO,
			A2.ID AS IDVAL,
			A2.NOMBRE AS ARCHIVOVAL,
			D.NOMBRE AS DOC,
			L.CERTUSUARIO_ADMINOST AS CERTUSUARIO,
			L.OBS_RE_ADMINOST AS OBSFASE1,
			A.NOMBRE AS ARCHIVO_FASE1,
			A.ID AS IDARCHIVO_FASE1,
			L.CERTFECHA_ADMINOST AS FECHAFASE_1,
			L.CERTHORA_ADMINOST AS HORAFASE_1,
			'FASE 1' AS FASE
		FROM LOG_DOCS_OST2 L
		INNER JOIN DOCS D
			ON D.ID_DOC = L.ID_DOC
		INNER JOIN ARCHIVOS A2
			ON A2.ID = L.ID_ARCHIVO
		LEFT JOIN ARCHIVOS A
			ON A.ID = L.IDARCH_RE_ADMIN
		WHERE
			(L.OST = @NROOST) AND
			(L.MADRE = @MADRE) AND
			(L.EMPRESA = @IDEMPRESA) AND
			(L.NIVEL = @NIVEL) AND
			(L.ID_DOC = @ID_DOC) AND
			(L.VALIDADO_ADMINOST IN ('SI','RE'))
		UNION
		SELECT
			L.VALIDADO,
			A2.ID AS IDVAL,
			A2.NOMBRE AS ARCHIVOVAL,
			D.NOMBRE AS DOC,
			L.CERTUSUARIO AS CERTUSUARIO,
			L.OBS_RE_VALIDADOR AS OBSFASE1,
			A.NOMBRE AS ARCHIVO_FASE1,
			A.ID AS IDARCHIVO_FASE1,
			L.CERTFECHA AS FECHAFASE_1,
			L.CERTHORA AS HORAFASE_1,
			'FASE 2' AS FASE
		FROM LOG_DOCS_OST2 L
		INNER JOIN DOCS D
			ON D.ID_DOC = L.ID_DOC
		INNER JOIN ARCHIVOS A2
			ON A2.ID = L.ID_ARCHIVO
		LEFT JOIN ARCHIVOS A
			ON A.ID = L.IDARCH_RE_VALIDADOR
		WHERE
			(L.OST = @NROOST) AND
			(L.MADRE = @MADRE) AND
			(L.EMPRESA = @IDEMPRESA) AND
			(L.NIVEL = @NIVEL) AND
			(L.ID_DOC = @ID_DOC) AND
			(L.VALIDADO IN ('SI','RE'))
		ORDER BY FECHAFASE_1 DESC, HORAFASE_1 DESC
		OFFSET 0 ROWS
	) SS

END

