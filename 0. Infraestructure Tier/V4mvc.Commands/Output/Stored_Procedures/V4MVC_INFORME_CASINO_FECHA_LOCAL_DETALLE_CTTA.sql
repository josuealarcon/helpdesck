CREATE PROCEDURE [dbo].[V4MVC_INFORME_CASINO_FECHA_LOCAL_DETALLE_CTTA]
(
 @FECHAINI			NVARCHAR(8)		= NULL
,@FECHAFIN			NVARCHAR(8)		= NULL
,@LOCAL				NVARCHAR(MAX)	= NULL
,@EMPRESA			NVARCHAR(10)	= NULL
,@DIVCOD			NVARCHAR(4)		= NULL
,@OP				NVARCHAR(2)		= NULL
,@RBNTIPOCONSUMO	NVARCHAR(10)	= NULL
,@RUT				NVARCHAR(10)	= NULL
,@SERVICIO			NVARCHAR(12)	= NULL
)
AS
BEGIN

	SELECT VALUE AS LOCAL INTO #TEMP_SPLIT_LOCALES
	FROM STRING_SPLIT(@LOCAL,',')

	--IF(@RBNTIPOCONSUMO != 'ERROR')
	--BEGIN

		SELECT DISTINCT C.SERVICIO		,C.LOCAL		,C.RUT		,C.EMPRESA
						,C.ACRONIMO		,C.FECHA		,C.HORA		,C.CANTIDAD
						,(CASE WHEN ISNULL(C.ERROR, '') <> '' THEN ISNULL(M.MSG_REPORT, 'ERROR') ELSE '' END  ) AS ERROR
						,C.CCOSTO		,C.COD_PDA		,W.NOMBRES	,W.APELLIDOS
						,D.DIVISION		,D.DIVCOD		,C.COD_PDA	,C.USUARIO
						,ADMINOST		,EE.ACRONIMO AS CONTRATISTA, C.OST, W2.NOMBRES + ' ' + W2.APELLIDOS AS ADMINOSTNOM  
		FROM WC3_VISTA_CASINO			AS C 
		LEFT OUTER JOIN WORKERS			AS W	ON C.RUT = W.RUT 
		LEFT OUTER JOIN MULTASTTO		AS M	ON C.ERROR = M.CODMULTA 
		INNER JOIN A024_DIVISIONES D			ON C.DIVISION = D.DIVCOD 
		LEFT OUTER JOIN OSTDIVLOCAL		AS O	ON C.OST = O.OST 
		AND C.DIVISION = O.DIVISION 
		AND O.MANDANTE IN (SELECT MANDANTE FROM A027_MANDANTES WHERE ACTIVO = 'SI') 
		LEFT OUTER JOIN WORKERS			AS W2	ON O.ADMINOST = W2.RUT 
		LEFT OUTER JOIN ENTERPRISE		AS EE	ON EE.IDEMPRESA = O.EMPRESA	
		WHERE C.SERVICIO <> '' 
		AND ISNULL(C.ERROR, '') = ''
		AND C.EMPRESA = ISNULL(@EMPRESA,C.EMPRESA)
		AND C.LOCAL IN (SELECT LOCAL FROM #TEMP_SPLIT_LOCALES)
		AND C.DIVISION = ISNULL(@DIVCOD, C.DIVISION)
		AND C.RUT = ISNULL(@RUT, C.RUT)
		AND C.SERVICIO = ISNULL(@SERVICIO, C.SERVICIO)
		AND C.FECHA BETWEEN ISNULL(@FECHAINI,C.FECHA) AND ISNULL(@FECHAFIN,C.FECHA)
		ORDER BY C.SERVICIO, C.LOCAL, C.FECHA, C.HORA  ASC 

	--END

END


--EXEC V4MVC_INFORME_CASINO_FECHA_LOCAL_DETALLE_CTTA '20170103','20170103','CAS_VEGAT','761264907','LB',NULL,NULL,NULL,NULL
