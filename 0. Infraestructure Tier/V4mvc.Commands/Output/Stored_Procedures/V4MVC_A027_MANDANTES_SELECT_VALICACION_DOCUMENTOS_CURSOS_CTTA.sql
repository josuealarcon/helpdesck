CREATE PROCEDURE [dbo].[V4MVC_A027_MANDANTES_SELECT_VALICACION_DOCUMENTOS_CURSOS_CTTA]
/*
EXEC V4MVC_A027_MANDANTES_SELECT_VALICACION_DOCUMENTOS_CURSOS_CTTA 1, '108','89526892'
*/
@RESTRICCIONES			INT = NULL
,@EMPRESA				NVARCHAR(20) = NULL
,@RUT					NVARCHAR(20) = NULL
AS			
BEGIN
DECLARE @VALOR2		NVARCHAR(1000)
DECLARE @VALOR3		NVARCHAR(1000)
DECLARE @VALOR2_Q2	NVARCHAR(1000)
DECLARE @VALOR3_Q2	NVARCHAR(1000)
DECLARE @IDDOCS_LT	NVARCHAR(1000)
DECLARE @IDDOCS_LB	NVARCHAR(1000)
DECLARE @IDDOCS_ES	NVARCHAR(1000)
DECLARE @IDDOCS_CH	NVARCHAR(1000)

CREATE TABLE #VALIDACIONDOCUMENTO 
(ID_DOC						NVARCHAR(50) COLLATE DATABASE_DEFAULT NOT NULL
,DIVISION					NVARCHAR(8) COLLATE DATABASE_DEFAULT NOT NULL)

CREATE TABLE #MENSAJES
(MENSAJE					NVARCHAR(MAX) COLLATE DATABASE_DEFAULT NOT NULL
,DIVISION_MENSAJE			NVARCHAR(8) COLLATE DATABASE_DEFAULT NOT NULL)

DECLARE @ID_DOC				NVARCHAR(50)
DECLARE @DIVISION			NVARCHAR(8)

DECLARE @NOMBRE				NVARCHAR(100)
DECLARE @EMP_COMUN			INT
DECLARE @DIV_COMUN			NVARCHAR(4)
DECLARE @SUBEDOC			NVARCHAR(4)	
DECLARE @ID_DOC_ONE			INT

DECLARE @CONTADOR_WHILE		INT
DECLARE @MAX_TABLA			INT
DECLARE @FILTRO				NVARCHAR(100)

DECLARE @TOTAL_MENSAJES_LT	INT	= 0
DECLARE @TOTAL_MENSAJES_LB	INT	= 0
DECLARE @TOTAL_MENSAJES_ES	INT	= 0
DECLARE @TOTAL_MENSAJES_CH	INT	= 0
			

	IF NOT EXISTS (SELECT * FROM A027_MANDANTES WHERE MANDANTE = @EMPRESA)
	BEGIN 
		
		IF @RESTRICCIONES = 1
			SELECT @VALOR2 = ISNULL(Valor2,'')		,@VALOR3 = ISNULL(Valor3,'')	FROM PARAMETROS_V2 WHERE Descripcion  = 'Cursos Persona Nueva'
			SELECT @VALOR2_Q2 = ISNULL(Valor2,'')	,@VALOR3_Q2 = ISNULL(Valor3,'') FROM PARAMETROS_V2 WHERE Descripcion  = 'Cursos Persona Nueva 2'
		IF @RESTRICCIONES = 2
			SELECT @VALOR2 = ISNULL(Valor2,'')		,@VALOR3 = ISNULL(Valor3,'')	FROM PARAMETROS_V2 WHERE Descripcion  = 'Cursos A1' 
			SELECT @VALOR2_Q2 = ISNULL(Valor2,'')	,@VALOR3_Q2 = ISNULL(Valor3,'') FROM PARAMETROS_V2 WHERE Descripcion  = 'Cursos A1 2'
	
		SELECT @IDDOCS_LT = REPLACE (@VALOR2 ,'-',',')
		SELECT @IDDOCS_LB = REPLACE (@VALOR3 ,'-',',')
		SELECT @IDDOCS_ES = REPLACE (@VALOR2_Q2 ,'-',',') 
		SELECT @IDDOCS_CH = REPLACE (@VALOR3_Q2 ,'-',',')
		
		INSERT INTO #VALIDACIONDOCUMENTO(ID_DOC,DIVISION)
		VALUES (@IDDOCS_LT,'LT'),(@IDDOCS_LB,'LB'),(@IDDOCS_ES,'ES'),(@IDDOCS_CH,'CH')
		--SELECT * FROM #VALIDACIONDOCUMENTO
		DECLARE CURSORDIVICIONES  CURSOR  READ_ONLY FOR 
			SELECT * FROM #VALIDACIONDOCUMENTO	
		OPEN CURSORDIVICIONES 
		FETCH NEXT FROM CURSORDIVICIONES INTO @ID_DOC ,@DIVISION 
		WHILE @@FETCH_STATUS = 0
			BEGIN
				DECLARE @QUERY nVARCHAR(MAX)
	
				IF OBJECT_ID('TEMPDB.DBO.#LISTADODOCUMENTOS') IS NOT NULL
					DROP TABLE #LISTADODOCUMENTOS
	
				CREATE TABLE #LISTADODOCUMENTOS
				(ID			INT
				,ID_DOC		INT
				,NOMBRE		NVARCHAR(100)
				,EMP_COMUN	INT
				,DIV_COMUN	NVARCHAR(4)
				,SUBEDOC	NVARCHAR(4))	
	
				EXEC ('  
				IF EXISTS (
					SELECT  ID_DOC FROM DOCS WHERE  ID_DOC IN (' + @ID_DOC + ' ) ) 
				BEGIN 
					INSERT INTO #LISTADODOCUMENTOS
					SELECT ROW_NUMBER() OVER(ORDER BY ID_DOC ASC) AS id, ID_DOC, NOMBRE, COMUN AS EMP_COMUN, ISNULL(COMUN_DIV,''NO'') AS DIV_COMUN, SUBEDOC FROM DOCS WHERE ID_DOC IN (' + @ID_DOC + ' ) 
				END ')
					--SELECT * FROM #LISTADODOCUMENTOS
					SELECT @MAX_TABLA = MAX(ID) FROM #LISTADODOCUMENTOS
				
					SET @CONTADOR_WHILE = 1
					WHILE (@CONTADOR_WHILE < = @MAX_TABLA)
					BEGIN 
						SET @FILTRO = ''
						SELECT	@ID_DOC_ONE=ID_DOC		,@NOMBRE=NOMBRE	 ,@SUBEDOC= SUBEDOC		,@EMP_COMUN=EMP_COMUN		
								,@DIV_COMUN = DIV_COMUN  
						FROM #LISTADODOCUMENTOS
						WHERE ID = @CONTADOR_WHILE
						SET @CONTADOR_WHILE = @CONTADOR_WHILE + 1
						IF (@SUBEDOC  =  'SI' ) 
						BEGIN
							IF (@DIV_COMUN = 'NO')
								SET @FILTRO  = ' AND (DIVISION = ''' + convert (varchar ,@DIVISION) +''')'
							IF (@EMP_COMUN = 0)
								SET @FILTRO  = ' AND (EMPRESA = ' + convert(varchar, @EMPRESA)  +')'
							SET @QUERY = (
								'IF NOT EXISTS (
									SELECT VALIDADO FROM DOCS_WORKERS DW 
									INNER JOIN ( SELECT MAX(ID_DOCS_WORKERS) AS ID_DOCS_WORKERS FROM DOCS_WORKERS
									WHERE (RUT = ''' + @RUT + ''') AND (ID_DOC = ' + CAST(@ID_DOC_ONE AS NVARCHAR) +')  '+ @FILTRO + '
									GROUP BY EMPRESA, DIVISION ) DWL ON DW.ID_DOCS_WORKERS = DWL.ID_DOCS_WORKERS 
									WHERE ISNULL(DW.VALIDADO,''NO'') = ''SI'' 
								)BEGIN
								PRINT ''''
								END
								ELSE 
								BEGIN
									INSERT INTO #MENSAJES (MENSAJE,DIVISION_MENSAJE) VALUES 
									( '''+ convert (varchar ,@NOMBRE)  +''' , ''' + convert (varchar ,@DIVISION) + ''')
								END')
							--PRINT @QUERY
							EXEC (@QUERY)
						END
					
					END
					FETCH NEXT FROM CURSORDIVICIONES INTO @ID_DOC,@DIVISION  
			END
		CLOSE CURSORDIVICIONES
		DEALLOCATE CURSORDIVICIONES
	
		SELECT @TOTAL_MENSAJES_LT = COUNT(1)  FROM #MENSAJES
		WHERE DIVISION_MENSAJE = 'LT'
		SELECT @TOTAL_MENSAJES_LB = COUNT(1)  FROM #MENSAJES
		WHERE DIVISION_MENSAJE = 'LB'
		SELECT @TOTAL_MENSAJES_ES = COUNT(1)  FROM #MENSAJES
		WHERE DIVISION_MENSAJE = 'ES'
		SELECT @TOTAL_MENSAJES_CH = COUNT(1)  FROM #MENSAJES
		WHERE DIVISION_MENSAJE = 'CH'
	
		IF (@TOTAL_MENSAJES_LT != 0 AND @TOTAL_MENSAJES_LB != 0 AND @TOTAL_MENSAJES_ES != 0 AND @TOTAL_MENSAJES_CH !=0)
		BEGIN
			IF (@RESTRICCIONES = 1)
				SELECT 'PERSONANUEVA' AS MENSAJE	
			ELSE
				SELECT 'A1RIESGOS' AS MENSAJE		
		END
		ELSE
		BEGIN 
			SELECT '' AS MENSAJE		
		END
	END
	ELSE
		SELECT '' AS MENSAJE
	
END


