CREATE PROCEDURE [dbo].[V4MVC_TRANSPORT_SELECT_DATATABLES_COUNT_CTTA]
(
 @IDEMPRESA				NVARCHAR(10)	= NULL
,@SEARCH_PATENTE		NVARCHAR(10)	= NULL
,@SEARCH_MARCA			NVARCHAR(50)	= NULL
,@SEARCH_MODELO			NVARCHAR(50)	= NULL
)
AS
BEGIN

	DECLARE @VALOR1 NVARCHAR(2)
	DECLARE @QUERY	NVARCHAR(MAX)

	SELECT @VALOR1 = ISNULL(VALOR1,'') FROM PARAMETROS_V2 WHERE DESCRIPCION = 'Pases Vehiculares'
	SET @QUERY = ''

	IF(@VALOR1 = '1')
		BEGIN
			SET @QUERY = @QUERY + 'SELECT COUNT(*) AS COUNT_TRANSPORT FROM
				(	SELECT DISTINCT D.PATENTE, D.ACRONIMO, D.MARCA, D.MODELO, D.TIPO FROM ( 
					SELECT T.PATENTE, E.ACRONIMO, T.MARCA, T.MODELO, T.TIPO FROM TRANSPORT_DIVISION_PASES TD 
					INNER JOIN TRANSPORT T ON TD.PATENTE = T.PATENTE 
					INNER JOIN ENTERPRISE E ON TD.EMPRESA = E.IDEMPRESA 
				WHERE (T.EMPRESA = ' + '''' + @IDEMPRESA + ''''
				IF @SEARCH_PATENTE IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.PATENTE LIKE ' + '''%' + @SEARCH_PATENTE + '%''' END
				IF @SEARCH_MARCA IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MARCA LIKE ' + '''%' + @SEARCH_MARCA + '%''' END
				IF @SEARCH_MODELO IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MODELO LIKE ' + '''%' + @SEARCH_MODELO + '%''' END
				SET @QUERY = @QUERY +')'	   
				SET @QUERY = @QUERY + 'UNION ALL  
				SELECT T.PATENTE, E.ACRONIMO, T.MARCA, T.MODELO, T.TIPO FROM TRANSPORT T 
				INNER JOIN ENTERPRISE E ON T.EMPRESA = E.IDEMPRESA
				WHERE (T.EMPRESA = ' + '''' + @IDEMPRESA + '''' 
				IF @SEARCH_PATENTE IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.PATENTE LIKE ' + '''%' + @SEARCH_PATENTE + '%''' END
				IF @SEARCH_MARCA IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MARCA LIKE ' + '''%' + @SEARCH_MARCA + '%''' END
				IF @SEARCH_MODELO IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MODELO LIKE ' + '''%' + @SEARCH_MODELO + '%''' END
				SET @QUERY = @QUERY + ')) D) X'
		END
	ELSE
		BEGIN
			SET @QUERY = @QUERY + 'SELECT COUNT(*) AS COUNT_TRANSPORT FROM
				(	SELECT DISTINCT D.PATENTE, D.ACRONIMO, D.MARCA, D.MODELO, D.TIPO FROM ( 
					SELECT T.PATENTE, E.ACRONIMO, T.MARCA, T.MODELO, T.TIPO FROM TRANSPORT_DIVISION_PASES TD 
					INNER JOIN TRANSPORT T ON TD.PATENTE = T.PATENTE 
					INNER JOIN ENTERPRISE E ON TD.EMPRESA = E.IDEMPRESA
				WHERE (T.EMPRESA = ' + '''' + @IDEMPRESA + ''''
				IF @SEARCH_PATENTE IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.PATENTE LIKE ' + '''%' + @SEARCH_PATENTE + '%''' END
				IF @SEARCH_MARCA IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MARCA LIKE ' + '''%' + @SEARCH_MARCA + '%''' END
				IF @SEARCH_MODELO IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MODELO LIKE ' + '''%' + @SEARCH_MODELO + '%''' END
				SET @QUERY = @QUERY + ')) D) X'
		END

	EXEC(@QUERY)

END