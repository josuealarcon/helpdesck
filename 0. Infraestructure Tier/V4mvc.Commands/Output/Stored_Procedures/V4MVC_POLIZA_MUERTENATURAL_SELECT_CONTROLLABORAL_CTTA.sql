CREATE PROCEDURE [dbo].[V4MVC_POLIZA_MUERTENATURAL_SELECT_CONTROLLABORAL_CTTA]
(
  @IDEMPRESA	NVARCHAR(11)
) AS
BEGIN
	DECLARE @ID_DOC INT = -1
	
	SELECT
		TOP 1
		@ID_DOC = ISNULL(Valor1, -1)
	FROM parametros_v2
	WHERE Descripcion = 'Pago de Poliza Muerte Natural'
	
	SELECT
		SS.PERIODO,
		SS.VALIDADO,
		SS.EMPRESA,
		SS.ID,
		SS.UNIQUE_ID,
		SS.DOC_ID,
		COALESCE(
			(
				SELECT
					TOP 1
						DD.ID_DISPUTA
				FROM DOCS_DISPUTA_CLABORAL DD
				WHERE
					DD.EMPRESA = SS.EMPRESA AND
					DD.PERIODO = SS.PERIODO AND
					DD.ID_DOC = @ID_DOC AND
					DD.ID = SS.UNIQUE_ID
				ORDER BY DD.ID_DISPUTA DESC
			), -1
		) AS DISPUTA_ID,
		COALESCE(
			(
				SELECT
					TOP 1
						DD.ESTADO
				FROM DOCS_DISPUTA_CLABORAL DD
				WHERE
					DD.EMPRESA = SS.EMPRESA AND
					DD.PERIODO = SS.PERIODO AND
					DD.ID_DOC = @ID_DOC AND
					DD.ID = SS.UNIQUE_ID
				ORDER BY DD.ID_DISPUTA DESC
			), ''
		) AS DISPUTA_ESTADO,
		IIF(EXISTS(
				SELECT * 
				FROM DOCS_DISPUTA_CLABORAL DD
				WHERE
					DD.EMPRESA = SS.EMPRESA AND
					DD.PERIODO = SS.PERIODO AND
					DD.ID_DOC = @ID_DOC AND
					DD.ID = SS.UNIQUE_ID
				ORDER BY DD.ID_DISPUTA DESC
				OFFSET 0 ROWS
		), 1 , 0) AS DISPUTA_EXISTE		
	FROM
	(
		SELECT
			PERIODO,
			VALIDADO,
			EMPRESA,
			ID,
			IIF(ID IS NULL OR CONVERT(NVARCHAR(40), ID) = '', NULL, ID) AS UNIQUE_ID,
			IIF(ID IS NULL OR CONVERT(NVARCHAR(40), ID) = '', NULL, ID) AS DOC_ID
		FROM POLIZA_MUERTENATURAL
		WHERE
			EMPRESA = @IDEMPRESA
		ORDER BY PERIODO DESC
		OFFSET 0 ROWS
	) SS	
END
