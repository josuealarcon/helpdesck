CREATE PROCEDURE [dbo].[V4MVC_LOTEPASES_SELECT_PASES_CTTA]
(
   @IDEMPRESA      NVARCHAR(11) = NULL 
  ,@ACTUAL		   BIT = NULL
) AS
BEGIN
	IF @ACTUAL = 1
		BEGIN
			SELECT
				LP.LOTEFFINAL,
				LP.LOTEFINICIO,
				LP.LOTENUM,
				LP.LOTEESTADO,
				LP.LOTEEMAIL,
				LP.LOTEGLOSA,
				LP.LOTEEMPRESA,
				D.DIVISION,
				D.DIVCOD,
				COALESCE(
							(
							  SELECT TOP 1 TIPOLT
							  FROM LOTEPASESFUN
							  WHERE (NLOTEPROC = LP.LOTENUM) AND (TIPORUT = 'EMPRESA')
							 ),
						'') AS TPASE,
				(SELECT COUNT(RUTLOTE) AS CUENTA FROM LOTEPASESFUN WHERE TIPORUT = 'FUNCIONARIO' AND NLOTEPROC = LOTENUM) AS NUMFUNCIONARIOS,
				(SELECT COUNT(RUTLOTE) AS CUENTA FROM LOTEPASESFUN WHERE TIPORUT = 'VEHICULO' AND NLOTEPROC = LOTENUM) AS NUMVEHICULOS
			FROM LOTEPASES AS LP,  A024_DIVISIONES AS D 
			WHERE
				D.DIVCOD = LP.DIVISION AND  
				LP.LOTEEMPRESA = @IDEMPRESA AND 
				SUBSTRING(LP.LOTEFINICIO,1,6) = SUBSTRING([dbo].[hoy](GETDATE()),1,6) 
		END
	ELSE
		BEGIN
			SELECT
				LP.LOTEFFINAL,
				LP.LOTEFINICIO,
				LP.LOTENUM,
				LP.LOTEESTADO,
				LP.LOTEEMAIL,
				LP.LOTEGLOSA,
				LP.LOTEEMPRESA,
				D.DIVISION,
				D.DIVCOD,
				COALESCE(
							(
							  SELECT TOP 1 TIPOLT
							  FROM LOTEPASESFUN
							  WHERE (NLOTEPROC = LP.LOTENUM) AND (TIPORUT = 'EMPRESA')
							 ),
						 '') AS TPASE,
				(SELECT COUNT(RUTLOTE) AS CUENTA FROM LOTEPASESFUN WHERE TIPORUT = 'FUNCIONARIO' AND NLOTEPROC = LOTENUM) AS NUMFUNCIONARIOS,
				(SELECT COUNT(RUTLOTE) AS CUENTA FROM LOTEPASESFUN WHERE TIPORUT = 'VEHICULO' AND NLOTEPROC = LOTENUM) AS NUMVEHICULOS 
			FROM LOTEPASES AS LP,  A024_DIVISIONES AS D 
			WHERE
				D.DIVCOD = LP.DIVISION AND  
				LP.LOTEEMPRESA = @IDEMPRESA AND 
				SUBSTRING(LP.LOTEFINICIO,1,6) <> SUBSTRING([dbo].[hoy](GETDATE()),1,6)
		END
END
