CREATE PROCEDURE [dbo].[V4MVC_RESERVA_BUS_SELECT_VALIDAEMPRESA_BUSESRESERVA_CTTA]   
(      
@EMPRESA NVARCHAR(10) = NULL
)      
AS      
BEGIN      
	DECLARE @PORCNO INT,
			@MENSAJE NVARCHAR(500)
     
	DECLARE @CONTROL_NOUTILIZA VARCHAR(4)
		   ,@PORC_NOUTILIZA INT
		   ,@DIAS_CASTIGO INT
		   ,@PERIODO_NOUTILIZA INT
	SELECT @CONTROL_NOUTILIZA = ISNULL(CONTROL_NOUTILIZA, 'NO')
		 , @PORC_NOUTILIZA    = ISNULL(PORC_NOUTILIZA, 100) 
		 , @DIAS_CASTIGO      = ISNULL(DIAS_CASTIGO, 7) 
		 , @PERIODO_NOUTILIZA = ISNULL(PERIODO_NOUTILIZA, 30) 
	FROM VIAJES_PARAMETROS

	DECLARE @CANTNO INT
		   ,@CANTOT INT
	SELECT  @CANTNO = SUM(CASE WHEN R.ESTADO = 'SI' AND R.UTILIZO = 'NO' THEN 1 ELSE 0 END) 
		  , @CANTOT = SUM(CASE WHEN R.ESTADO = 'SI' THEN 1 ELSE 0 END) 
	FROM RESERVA_BUS R
	INNER JOIN PROGBUS P ON P.IDPROG = R.IDPROG 
	WHERE R.EMPRESA = @EMPRESA
	AND P.FECHA BETWEEN DATEADD(DAY,-1*@PERIODO_NOUTILIZA,GETDATE()) AND DATEADD(DAY,-1,GETDATE())

				IF @CANTNO > 0 And @CANTOT > 0 
				BEGIN
					SET @PORCNO = (@CANTNO / @CANTOT) * 100
					IF(@PORCNO) >= @PORC_NOUTILIZA
					BEGIN
							SET @MENSAJE = 'Estimado usuario su empresa se encuentra con restriccion de reservas por reservas no utilizadas. Solo podra reservar ' + CONVERT(VARCHAR(10),@DIAS_CASTIGO) + ' dias en adelante.'
					END
					ELSE
					BEGIN
							SET @MENSAJE = ''
					END
				END
	SELECT @MENSAJE AS MENSAJE     
END 
