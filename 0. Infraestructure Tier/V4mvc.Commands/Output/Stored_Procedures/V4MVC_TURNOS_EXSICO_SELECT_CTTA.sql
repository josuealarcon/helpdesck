CREATE PROCEDURE [dbo].[V4MVC_TURNOS_EXSICO_SELECT_CTTA]
(
 @FECHARES					NVARCHAR(8)  
)
AS
BEGIN

	CREATE TABLE #LISTA_TURNOS
	(
		HORAINICIO			NVARCHAR(8)		 COLLATE DATABASE_DEFAULT NOT NULL,
		HORATERMINO			NVARCHAR(8)		 COLLATE DATABASE_DEFAULT NOT NULL,
		TURNOS_HORA			INT,
		ACTIVO				NVARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,
		OCUPADAS			INT,
		HORA_ACTIVO			NVARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL
	)

	DECLARE @CONTADOR		INT   
	DECLARE @HORA_INICIO	NVARCHAR(8)
	DECLARE @HORA_TERMINO	NVARCHAR(8)
	DECLARE @HORA_FIN		NVARCHAR(8)
	DECLARE @HORAINI_COL	NVARCHAR(8)
	DECLARE @HORAFIN_COL	NVARCHAR(8)
	DECLARE @TURNOSPORHORA	INT
	DECLARE @DATE1			DATETIME
	DECLARE @DATE2			DATETIME
	DECLARE @DATE_DIF		INT
	DECLARE @OCUPADAS		INT
	DECLARE @VAR_HORA		NVARCHAR(8)
	DECLARE @FECHAMASHORA	DATETIME


	SET @HORA_INICIO	= (SELECT HORAINI		FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORA_FIN		= (SELECT HORAFIN		FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORAINI_COL	= (SELECT HORAINI_COL	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORAFIN_COL	= (SELECT HORAFIN_COL	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @TURNOSPORHORA	= (SELECT FUNCPORHORA	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @DATE1			= @HORA_INICIO
	SET @DATE2			= @HORA_FIN

	SET @DATE_DIF = (SELECT (CAST((@DATE1 - @DATE2) AS FLOAT) * -24.0))
	SET @CONTADOR = 1

	SET @FECHAMASHORA = @FECHARES
	SET @FECHAMASHORA = DATEADD(HOUR,DATEPART(HOUR, DBO.AHORA(GETDATE())),@FECHAMASHORA)
	SET @FECHAMASHORA = DATEADD(MINUTE,DATEPART(MINUTE, DBO.AHORA(GETDATE())),@FECHAMASHORA)


	PRINT(DATEDIFF(HOUR, GETDATE(),@FECHAMASHORA))

	WHILE ( @CONTADOR <= @DATE_DIF )
	BEGIN
		SET @HORA_TERMINO = CONVERT(VARCHAR,(DATEADD(HOUR, 1 ,@HORA_INICIO)),8)

		SET @OCUPADAS = (SELECT COUNT(ID) FROM RESERVAS_EXSICO WHERE HORAINICIO = @HORA_INICIO AND HORATERMINO = @HORA_TERMINO AND FECHARES = @FECHARES)

		IF(DATEDIFF(HOUR, GETDATE(),@FECHAMASHORA) <= 24)
		BEGIN
				IF(@HORA_INICIO <= dbo.AHORA(GETDATE()))
				BEGIN
					SET @VAR_HORA = 'NO'
				END
				ELSE
				BEGIN
					SET @VAR_HORA = 'SI'
				END
		END
		ELSE
		BEGIN
				SET @VAR_HORA = 'SI'
		END

		INSERT INTO	#LISTA_TURNOS VALUES (@HORA_INICIO,CONVERT(VARCHAR,(DATEADD(HOUR, 1 ,@HORA_INICIO)),8),@TURNOSPORHORA,'SI',@OCUPADAS,@VAR_HORA)
		SET @HORA_INICIO = CONVERT(VARCHAR,(DATEADD(HOUR, 1 ,@HORA_INICIO)),8)
		SET @CONTADOR = @CONTADOR +1   

	END

	UPDATE #LISTA_TURNOS
	SET		ACTIVO='NO'
	WHERE	HORAINICIO		>=		@HORAINI_COL	AND		HORAINICIO		<		@HORAFIN_COL
	AND		HORATERMINO		>		@HORAINI_COL	AND		HORATERMINO		<=		@HORAFIN_COL

	SELECT  HORAINICIO		,HORATERMINO	,TURNOS_HORA	,ACTIVO 
			,OCUPADAS		,HORA_ACTIVO
	FROM #LISTA_TURNOS

END
