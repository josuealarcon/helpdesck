CREATE PROCEDURE [dbo].[V4MVC_GET_WC3_VISTA_CTRLING_INFORME_CENSOACCESOS]
(
@FECHAINI  NVARCHAR(8)       = NULL,
@FECHAFIN  NVARCHAR(8)       = NULL,
@DIVCOD  NVARCHAR(4)         = NULL,
@EMPRESA  NVARCHAR(10)       = NULL
) AS
BEGIN

 WITH vw AS  
 (  
SELECT  ACRONIMO, EMPRESA,FECHA,SUM(ING) AS ING
FROM (     SELECT CHILD.FECHA, CHILD.RUTINGRESO, CHILD.EMPRESA, CHILD.ACRONIMO, WORKERS.NOMBRES, WORKERS.APELLIDOS,CASE WHEN CHILD.ING> 0 THEN 1 ELSE 0 END AS ING  
           FROM   (        SELECT RUTINGRESO, EMPRESA, ACRONIMO, SUM(INGRESO) AS ING, FECHA  
			               FROM WC3_VISTA_CTRLING   WHERE DIVISION = @DIVCOD  AND (EMPRESA = @EMPRESA)  AND (FECHA  BETWEEN @FECHAINI AND @FECHAFIN)  GROUP BY RUTINGRESO, FECHA, EMPRESA, ACRONIMO 
		          ) CHILD 
				  , WORKERS WHERE CHILD.Rutingreso = WORKERS.RUT 
	 ) AS DETALLE GROUP BY EMPRESA,FECHA, ACRONIMO 
)   


SELECT  CONVERT(VARCHAR(8),X.[Date],112) AS FECHA ,ING = COALESCE(t.ING,0)
FROM 
    (SELECT [Date] = DATEADD(Day,Number,@FECHAINI)  
    FROM  master..spt_values  
    WHERE Type='P' 
    AND DATEADD(day,Number,@FECHAINI) <= @FECHAFIN)X
LEFT JOIN  vw t 
ON X.[Date] = t.FECHA
 
END	
