CREATE PROCEDURE [dbo].[V4MVC_A203_BUS_PAS_SELECT_BUSESRESERVA_CTTA]
(@DIAS NVARCHAR(20) = NULL) AS
BEGIN
	DECLARE @strSQL as nvarchar(MAX)

	SET @strSQL= 'SELECT			BT.IDPROG											, BT.PATENTE																						, BT.FECHA					, BT.HORA
								  , BT.ORIGEN											, BT.DESTINO																						, BT.DISPONIBLES			, BT.RESERVAS
								  , BT.DURACION											,(SELECT DIVISION FROM A024_DIVISIONES WHERE (ACTIVO = ''SI'') AND DIVCOD = BT.DIVISION) AS DIVISION, BT.FLOTA					, BT.DESCRIPCION
								  , ISNULL(BT.CAPACIDAD_LIBERA, 90) AS CAPACIDAD_LIBERA	, CASE WHEN (CONVERT(VARCHAR(16), (BT.FECHA+'' ''+BT.HORA), 102) >= CONVERT(VARCHAR(16), DATEADD(hh, 0, GETDATE()),120)) THEN 1 ELSE 0 END AS PERMITIDO
	FROM A203_BUS_PAS BT 
	WHERE (FECHA <= CONVERT(VARCHAR(8),DATEADD(d, 45, GETDATE()),112)) AND (FECHA >= CONVERT(VARCHAR(8),GETDATE(), 112))'  

	IF @Dias <> ''
	BEGIN
		Set @strSQL = @strSQL + N' AND DATEPART(DW, FECHA) IN (' + @Dias + ')'
	END

	SET @strSQL = @strSQL + N' ORDER BY FECHA, HORA, ORIGEN, DESTINO, RESERVAS DESC, PATENTE'
	EXEC sp_executesql @strSQL  
	PRINT @strSQL
END
