CREATE PROCEDURE [dbo].[V4MVC_DOCS_SELECT_GRID_FICHAVEHICULODETALLE_INFORMECONSULTARAPIDA_CTTA]
(
  @DIVCOD NVARCHAR(4),
  @PATENTE NVARCHAR(10),
  @IDEMPRESA NVARCHAR(20)
) AS 
BEGIN

  SELECT DOCS.COMUN,		ISNULL(DOCS.COMUN_DIV,'NO') AS COMUN_DIV,			DOCS.NOMBRE,			DOCS.ID_DOC_OPCION AS OPCION, 
		 DOCS.ID_DOC,		DOCS.CAMPO,										    ISNULL(DOCS.SUBEDOC, 'NO') AS SUBEDOC,  
		(SELECT TOP 1 ISNULL(DF.NOMBRE ,'') FROM DOCS_FEC AS DF WHERE (DF.ID_DOC_DEPEND = DOCS.ID_DOC)  AND (ACTIVO = 'SI') ORDER BY ORDEN ASC) AS NOMBRE_FECHA,
		(SELECT TOP 1 ISNULL(DF.ID_DOC_FEC ,'') FROM DOCS_FEC AS DF WHERE (DF.ID_DOC_DEPEND = DOCS.ID_DOC)  AND (ACTIVO = 'SI') ORDER BY ORDEN ASC) AS ID_DOC_FEC,
		(CASE DOCS.COMUN WHEN 0 THEN
				CASE ISNULL(DOCS.COMUN_DIV,'NO') WHEN 'NO'  THEN
				  (SELECT TOP 1 ISNULL(VALIDADO,'') FROM DOCS_TRANSPORT WHERE EMPRESA=@IDEMPRESA AND  (PATENTE = @PATENTE) AND ( (DIVISION = @DIVCOD) OR (ISNULL(DIVISION, 'AA') = 'AA') ) AND (ID_DOC = DOCS.ID_DOC))
				  ELSE
				  (SELECT TOP 1 ISNULL(VALIDADO,'') FROM DOCS_TRANSPORT WHERE EMPRESA=@IDEMPRESA AND  (PATENTE = @PATENTE) AND (ID_DOC = DOCS.ID_DOC))
				 END  
		 ELSE 

				CASE ISNULL(DOCS.COMUN_DIV,'NO') WHEN 'NO'  THEN
				  (SELECT TOP 1 ISNULL(VALIDADO,'') FROM DOCS_TRANSPORT WHERE  (PATENTE = @PATENTE) AND ( (DIVISION = @DIVCOD) OR (ISNULL(DIVISION, 'AA') = 'AA') ) AND (ID_DOC = DOCS.ID_DOC))
				  ELSE
				  (SELECT TOP 1 ISNULL(VALIDADO,'') FROM DOCS_TRANSPORT WHERE  (PATENTE = @PATENTE) AND (ID_DOC = DOCS.ID_DOC))
				 END 

		 END) AS VALIDADO,
		(CASE DOCS.COMUN WHEN 0 THEN
				CASE ISNULL(DOCS.COMUN_DIV,'NO') WHEN 'NO'  THEN
				  (SELECT TOP 1 ISNULL(ID,'') FROM DOCS_TRANSPORT WHERE EMPRESA=@IDEMPRESA AND  (PATENTE = @PATENTE) AND ( (DIVISION = @DIVCOD) OR (ISNULL(DIVISION, 'AA') = 'AA') ) AND (ID_DOC = DOCS.ID_DOC))
				  ELSE
				  (SELECT TOP 1 ISNULL(ID,'') FROM DOCS_TRANSPORT WHERE EMPRESA=@IDEMPRESA AND  (PATENTE = @PATENTE) AND (ID_DOC = DOCS.ID_DOC))
				 END  
		 ELSE 

				CASE ISNULL(DOCS.COMUN_DIV,'NO') WHEN 'NO'  THEN
				  (SELECT TOP 1 ISNULL(ID,'') FROM DOCS_TRANSPORT WHERE  (PATENTE = @PATENTE) AND ( (DIVISION = @DIVCOD) OR (ISNULL(DIVISION, 'AA') = 'AA') ) AND (ID_DOC = DOCS.ID_DOC))
				  ELSE
				  (SELECT TOP 1 ISNULL(ID,'') FROM DOCS_TRANSPORT WHERE  (PATENTE = @PATENTE) AND (ID_DOC = DOCS.ID_DOC))
				 END 

		 END) AS ID,
         [dbo].[V4MVC_FN_GET_ESTADO_FECHA_VEHICULO_LOCAL]( (SELECT TOP 1 ISNULL(DF.ID_DOC_FEC ,'') FROM DOCS_FEC AS DF WHERE (DF.ID_DOC_DEPEND = DOCS.ID_DOC)  AND (ACTIVO = 'SI') ORDER BY ORDEN ASC),@PATENTE,@DIVCOD,@IDEMPRESA) AS COLORFECHA
  FROM DOCS 
  WHERE ID_DOC IN (SELECT ID_DOC FROM DOCS_TIPOPASE WHERE TIPOPASE = '25' AND (DIVISION = @DIVCOD OR DIVISION = 'AA')) 
  AND (ACTIVO = 'SI')  
  AND (DOCS.ID_TIPO_PROPIETARIO = '3')
END
