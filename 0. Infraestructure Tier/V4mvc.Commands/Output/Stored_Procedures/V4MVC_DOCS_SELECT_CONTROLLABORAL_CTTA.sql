CREATE PROCEDURE [dbo].[V4MVC_DOCS_SELECT_CONTROLLABORAL_CTTA]
(
   @IDEMPRESA				NVARCHAR(10)	
  ,@CLABORAL_MSG_EXISTE		INT OUTPUT
  ,@VALIDA					INT OUTPUT
  ,@CARGAR					INT OUTPUT
  ,@CM_EXISTEN_DOCS			INT OUTPUT
  ,@CM_NOMBRE				NVARCHAR(50) OUTPUT
  ,@CM_IDDOC				INT OUTPUT					
)
AS
BEGIN
	DECLARE @DIA_PROG NVARCHAR(2) = NULL
	DECLARE @NUMDIA_HOY INT = DAY(GETDATE())
	SET @VALIDA = 0
	SET @CLABORAL_MSG_EXISTE = 0
	SET @CARGAR = 0
	SET @CM_EXISTEN_DOCS = 0
	SET @CM_IDDOC = -1

	IF(EXISTS(
			SELECT *
			FROM CLABORAL_MSG
			WHERE ACTIVO = 'SI'
		))
		BEGIN
			SET @CLABORAL_MSG_EXISTE = 1
			IF(EXISTS(
					SELECT *
					FROM DOCS_ENTERPRISE
					WHERE
						ID_DOC = 131 AND
						IDEMPRESA = @IDEMPRESA AND
						VALIDADO = 'SI'
				))
				BEGIN
					SET @VALIDA = 1
				END
		END
	ELSE
		BEGIN
			SET @VALIDA = 1
		END

	SELECT TOP 1 @DIA_PROG = DIA
	FROM DOCS_WORKERS_PROGRAMACION
	WHERE IDEMPRESA = @IDEMPRESA

	IF(@DIA_PROG IS NOT NULL)
		BEGIN
			IF(@DIA_PROG = '')
				BEGIN
					SET @CARGAR = 1
				END
			ELSE
				BEGIN
					IF(CONVERT(INT, @DIA_PROG) = @NUMDIA_HOY)
						BEGIN
							SET @CARGAR = 1
						END
				END
		END

	IF(@CARGAR = 1)
		BEGIN
			SELECT
				TOP 1
				@CM_IDDOC = ID_DOC,
				@CM_NOMBRE = NOMBRE
			FROM DOCS
			WHERE
				ACTIVO = 'SI' AND
				ID_TIPO_PROPIETARIO = 2 AND
				ID_DOC_OPCION = 2 AND
				ID_DOC = 116
			ORDER BY NOMBRE
			
			IF(@CM_IDDOC <> -1)
				BEGIN
					SET @CM_EXISTEN_DOCS = 1
				END
		END
	
	SELECT
		URL_CTRLLABORAL_V4,
		NOMBRE,
		ID_DOC,
		URLCOMO,
		URLDONDE
	FROM DOCS
	WHERE
		ACTIVO = 'SI' AND
		ID_TIPO_PROPIETARIO = 2 AND
		ID_DOC_OPCION = 2
	ORDER BY NOMBRE
END
