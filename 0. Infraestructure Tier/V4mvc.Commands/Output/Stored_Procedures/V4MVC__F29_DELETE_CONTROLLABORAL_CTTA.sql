CREATE PROCEDURE [dbo].[V4MVC__F29_DELETE_CONTROLLABORAL_CTTA]
(
  @IDEMPRESA		NVARCHAR(10)
 ,@PERIODO			NVARCHAR(6)
 ,@USUARIO			NVARCHAR(10)
 ,@DISPUTA_ID		INT
 ,@DISPUTA_EXISTE	INT OUTPUT
 ,@DISPUTA_EMPRESA	NVARCHAR(12) OUTPUT
 ,@DISPUTA_FECHA	NVARCHAR(8) OUTPUT
) AS
BEGIN
	DECLARE @CURR_FECHA NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 112) /* yyyymmdd */
	DECLARE @CURR_TIEMPOFULL NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 108) /* hh:mm:ss */

	DECLARE @F29_EXISTS BIT = 0
	DECLARE @F29_EMPRESA NVARCHAR(20)
	DECLARE @F29_PERIODO NVARCHAR(6)

	DECLARE @F29_VENTAS	BIGINT
	DECLARE @F29_COMPRAS	BIGINT
	DECLARE @F29_REMANENTE	BIGINT
	DECLARE @F29_PPM	BIGINT
	DECLARE @F29_IRENTA	BIGINT
	DECLARE @F29_BHONORARIOS	BIGINT
	DECLARE @F29_IMP_PAGADO	BIGINT
	DECLARE @F29_REMMESANT	BIGINT
	DECLARE @F29_MULTAS	BIGINT
	DECLARE @F29_DEPRECIACION	BIGINT
	DECLARE @F29_DEPRECACUM	BIGINT
	DECLARE @F29_CAPITAL	BIGINT
	DECLARE @F29_ESTADOCERT	NVARCHAR(20)

	DECLARE @F29_VALIDADO NVARCHAR(2)
	DECLARE @F29_ID UNIQUEIDENTIFIER
	DECLARE @F29_OBSERVACION NVARCHAR(500)
	DECLARE @F29_USUARIO NVARCHAR(10)
	DECLARE @F29_FECHASUBE NVARCHAR(8)
	DECLARE @F29_HORASUBE NVARCHAR(8)
	DECLARE @F29_CERTUSUARIO NVARCHAR(20)
	DECLARE @F29_CERTFECHA NVARCHAR(8)
	DECLARE @F29_CERTHORA NVARCHAR(8)

	DECLARE @DSP_ID_DISPUTA INT
	DECLARE @DSP_ID_DOC INT
	DECLARE @DSP_ID UNIQUEIDENTIFIER
	DECLARE @DSP_USUARIO NVARCHAR(10)
	DECLARE @DSP_HORA NVARCHAR(8)
	DECLARE @DSP_OBSERVACION NVARCHAR(1000)
	DECLARE @DSP_CERTUSUARIO NVARCHAR(10)
	DECLARE @DSP_CERTFECHA NVARCHAR(8)
	DECLARE @DSP_CERTHORA NVARCHAR(8)
	DECLARE @DSP_ESTADO	NVARCHAR(2)
	DECLARE @DSP_REVALUSUARIO NVARCHAR(10)
	DECLARE @DSP_REVALFECHA	NVARCHAR(8)
	DECLARE @DSP_REVALHORA	NVARCHAR(8)
	DECLARE @DSP_OBSERVACION_REVAL	NVARCHAR(1000)
	DECLARE @DSP_VALIDADO NVARCHAR(2)
	DECLARE @DSP_PERIODO NVARCHAR(6)
	DECLARE @DSP_ID_CERTIFICADO INT

	SET @DISPUTA_EXISTE = 0
	SET @DISPUTA_EMPRESA = ''
	SET @DISPUTA_FECHA = ''

	SELECT
		TOP 1
		@F29_EXISTS = 1,
		@F29_EMPRESA = EMPRESA,
		@F29_PERIODO = PERIODO,

		@F29_VENTAS  = VENTAS,
		@F29_COMPRAS  = COMPRAS,
		@F29_REMANENTE  = REMANENTE,
		@F29_PPM  = PPM,
		@F29_IRENTA  = IRENTA,
		@F29_BHONORARIOS  = BHONORARIOS,
		@F29_IMP_PAGADO  = IMP_PAGADO,
		@F29_REMMESANT  = REMMESANT,
		@F29_MULTAS  = MULTAS,
		@F29_DEPRECIACION  = DEPRECIACION,
		@F29_DEPRECACUM  = DEPRECACUM,
		@F29_CAPITAL  = CAPITAL,
		@F29_ESTADOCERT  = ESTADOCERT,

		@F29_VALIDADO = VALIDADO,
		@F29_ID = ID,
		@F29_OBSERVACION = OBSERVACION,
		@F29_USUARIO = USUARIO,
		@F29_FECHASUBE = FECHASUBE,
		@F29_HORASUBE = HORASUBE,
		@F29_CERTUSUARIO = CERTUSUARIO,
		@F29_CERTFECHA = CERTFECHA,
		@F29_CERTHORA = CERTHORA
	FROM _F29
	WHERE
		EMPRESA = @IDEMPRESA AND
		PERIODO = @PERIODO

	IF(@F29_EXISTS = 1)
		BEGIN

			INSERT INTO _F29_LOG
						(
							EMPRESA,
							PERIODO,
							VENTAS,
							COMPRAS,
							REMANENTE,
							PPM,
							IRENTA,
							BHONORARIOS,
							IMP_PAGADO,
							REMMESANT,
							MULTAS,
							DEPRECIACION,
							DEPRECACUM,
							CAPITAL,
							ID,
							VALIDADO,
							OBSERVACION,
							ESTADOCERT,
							USUARIO,
							FECHASUBE,
							HORASUBE,
							CERTUSUARIO,
							CERTFECHA,
							CERTHORA,
							USUARIODEL,
							FECHADEL,
							HORADEL
						)
			VALUES
						(
							@F29_EMPRESA,
							@F29_PERIODO,
							@F29_VENTAS,
							@F29_COMPRAS,
							@F29_REMANENTE,
							@F29_PPM,
							@F29_IRENTA,
							@F29_BHONORARIOS,
							@F29_IMP_PAGADO,
							@F29_REMMESANT,
							@F29_MULTAS,
							@F29_DEPRECIACION,
							@F29_DEPRECACUM,
							@F29_CAPITAL,
							@F29_ID,
							@F29_VALIDADO,
							@F29_OBSERVACION,
							@F29_ESTADOCERT,
							@F29_USUARIO,
							@F29_FECHASUBE,
							@F29_HORASUBE,
							@F29_CERTUSUARIO,
							@F29_CERTFECHA,
							@F29_CERTHORA,
							@USUARIO,
							@CURR_FECHA,
							@CURR_TIEMPOFULL
						)
			
			/*--------------------------*/
			
			SELECT
				TOP 1
				@DISPUTA_EXISTE = 1,
				@DSP_ID_DISPUTA = ID_DISPUTA,
				@DISPUTA_EMPRESA = EMPRESA,
				@DSP_ID_DOC = ID_DOC,
				@DSP_ID = ID,
				@DSP_USUARIO = USUARIO,
				@DISPUTA_FECHA = FECHA,
				@DSP_HORA = HORA,
				@DSP_OBSERVACION = OBSERVACION,
				@DSP_CERTUSUARIO = CERTUSUARIO,
				@DSP_CERTFECHA = CERTFECHA,
				@DSP_CERTHORA = CERTHORA,
				@DSP_ESTADO = ESTADO,
				@DSP_REVALUSUARIO = REVALUSUARIO,
				@DSP_REVALFECHA = REVALFECHA,
				@DSP_REVALHORA = REVALHORA,
				@DSP_OBSERVACION_REVAL = OBSERVACION_REVAL,
				@DSP_VALIDADO = VALIDADO,
				@DSP_PERIODO = PERIODO,
				@DSP_ID_CERTIFICADO = ID_CERTIFICADO
			FROM DOCS_DISPUTA_CLABORAL
			WHERE
				ID_DISPUTA = @DISPUTA_ID AND
				ESTADO = 'NO'

			IF(@DISPUTA_EXISTE = 1)
				BEGIN
					INSERT INTO DOCS_DISPUTA_CLABORAL_LOG
							(
								ID_DISPUTA,
								EMPRESA,
								ID_DOC,
								ID,
								USUARIO,
								FECHA,
								HORA,
								OBSERVACION,
								CERTUSUARIO,
								CERTFECHA,
								CERTHORA,
								ESTADO,
								REVALUSUARIO,
								REVALFECHA,
								REVALHORA,
								OBSERVACION_REVAL,
								VALIDADO,
								PERIODO,
								ID_CERTIFICADO,
								USRMOD,
								FECHAMOD,
								HORAMOD,
								ACCION
							)
					VALUES (
								@DSP_ID_DISPUTA,
								@DISPUTA_EMPRESA,
								@DSP_ID_DOC,
								@DSP_ID,
								@DSP_USUARIO,
								@DISPUTA_FECHA,
								@DSP_HORA,
								@DSP_OBSERVACION,
								@DSP_CERTUSUARIO,
								@DSP_CERTFECHA,
								@DSP_CERTHORA,
								@DSP_ESTADO,
								@DSP_REVALUSUARIO,
								@DSP_REVALFECHA,
								@DSP_REVALHORA,
								@DSP_OBSERVACION_REVAL,
								@DSP_VALIDADO,
								@DSP_PERIODO,
								@DSP_ID_CERTIFICADO,
								@USUARIO,
								@CURR_FECHA,
								@CURR_TIEMPOFULL,
								'ELIMINADO'
							)

					DELETE DOCS_DISPUTA_CLABORAL WHERE ID_DISPUTA = @DISPUTA_ID AND ESTADO = 'NO'
				END

			DELETE FROM _F29 WHERE PERIODO = @PERIODO AND EMPRESA = @IDEMPRESA

		END
END
