CREATE PROCEDURE [dbo].[V4MVC_LIST_EXSICO_SELECT_CTTA]
AS
BEGIN

	CREATE TABLE #LISTA_EXSICO
	(
	 FECHA				NVARCHAR(8)		COLLATE DATABASE_DEFAULT NOT NULL, 
	 DIA_SEMANA			NVARCHAR(3)		COLLATE DATABASE_DEFAULT NOT NULL, 
	 CUPOS_DISPONIBLES	INT
	,OCUPADOS			INT
	,ACTIVO				NVARCHAR(2)		COLLATE DATABASE_DEFAULT NOT NULL, 
	FECHA_HOY			NVARCHAR(2)		COLLATE DATABASE_DEFAULT NOT NULL
	)

	DECLARE @DATE1				DATETIME
	DECLARE @DATE2				DATETIME
	DECLARE @DATE3				DATETIME
	DECLARE @DATE4				DATETIME
	DECLARE @DATE5				DATETIME
	DECLARE @DATE6				DATETIME
	DECLARE @CONTADOR			INT
	DECLARE @DIF_FECHAS			INT
	DECLARE @HORA_INICIO		NVARCHAR(8)
	DECLARE @HORA_FIN			NVARCHAR(8)
	DECLARE @HORAINI_COL		NVARCHAR(8)
	DECLARE @HORAFIN_COL		NVARCHAR(8)
	DECLARE @FILTRO_FECHA		NVARCHAR(8)
	DECLARE @TURNOSPORHORA		INT
	DECLARE @DATE_DIF			INT
	DECLARE @CUPOS_DISPONIBLES	INT
	DECLARE @OCUPADOS			INT

	SET @HORA_INICIO	= (SELECT HORAINI		FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORA_FIN		= (SELECT HORAFIN		FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORAINI_COL	= (SELECT HORAINI_COL	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @HORAFIN_COL	= (SELECT HORAFIN_COL	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @TURNOSPORHORA	= (SELECT FUNCPORHORA	FROM	TAB_RESERVASICO		WHERE	ACTIVO='SI')
	SET @DATE1			= @HORA_INICIO
	SET @DATE2			= @HORA_FIN
	SET @DATE3			= @HORAINI_COL
	SET @DATE4			= @HORAFIN_COL
	SET @DATE5			= @HORA_INICIO
	SET @DATE6			= @HORA_FIN

	SET @CONTADOR = 1
	SET @DATE1	= dbo.HOY(GETDATE())
	SET @DATE2	= (SELECT FECHALIMITE FROM TAB_RESERVASICO WHERE ACTIVO='SI')

	SET @DIF_FECHAS = (SELECT (DATEDIFF(DAY,@DATE1,@DATE2)))
	SET @CUPOS_DISPONIBLES =  ((SELECT (CAST((@DATE5 - @DATE6) AS FLOAT) * -24.0) - (CAST((@DATE3 - @DATE4) AS FLOAT) * -24.0)) * @TURNOSPORHORA )

	WHILE (@CONTADOR <= @DIF_FECHAS + 1)
	BEGIN
	
		SET @FILTRO_FECHA	= ((CONVERT(VARCHAR(8),@DATE1,112)))
		SET @OCUPADOS		= (SELECT COUNT(ID) FROM RESERVAS_EXSICO WHERE FECHARES = @FILTRO_FECHA)
		SET @CONTADOR		= @CONTADOR + 1

		INSERT INTO #LISTA_EXSICO VALUES ((CONVERT(VARCHAR(8),@DATE1,112)),(SELECT SUBSTRING(UPPER(DATENAME(DW, @DATE1)),1,3)),@CUPOS_DISPONIBLES,@OCUPADOS,'SI','NO')

		SET @DATE1 = DATEADD(DAY, 1, @DATE1)  

		IF((SELECT LUN FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND LUN ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='LUN' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT MAR FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND MAR ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='MAR' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT MIE FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND MIE ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='MIE' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT JUE FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND JUE ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='JUE' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT VIE FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND VIE ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='VIE' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT SAB FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND SAB ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='SAB' COLLATE Modern_Spanish_CI_AI
		END

		IF((SELECT DOM FROM TAB_RESERVASICO WHERE ACTIVO='SI' AND DOM ='NO') = 'NO')
		BEGIN
			UPDATE #LISTA_EXSICO
			SET ACTIVO='NO'
			WHERE DIA_SEMANA='DOM' COLLATE Modern_Spanish_CI_AI
		END

	END

	UPDATE #LISTA_EXSICO
	SET FECHA_HOY='SI'
	WHERE FECHA <= dbo.HOY(GETDATE())

	SELECT FECHA AS FECHARES,CUPOS_DISPONIBLES,OCUPADOS,ACTIVO,FECHA_HOY FROM #LISTA_EXSICO
	WHERE ACTIVO='SI'

END
