CREATE PROCEDURE [dbo].[V4MVC_TRANSPORT_SELECT_BUSCADORCTTA]                
(             
@IDISPLAYSTART	INT,              
@IDISPLAYLENGTH INT,              
@SEARCH_PATENTE NVARCHAR(8) = NULL,        
@SEARCH_MARCA	NVARCHAR(50) = NULL,        
@SEARCH_MODELO	NVARCHAR(50) = NULL,  
@SEARCH_TIPO	NVARCHAR(20) = NULL,
@SEARCH_ANOFAB	NVARCHAR(4) = NULL,
@SORT_COLUMN	NVARCHAR(4) = NULL,        
@SORT_DIRECTION NVARCHAR(4) = NULL        
) AS                
BEGIN            
      DECLARE @QUERY NVARCHAR(MAX)
	SET @QUERY  = 'SELECT  T.PATENTE,  T.MARCA,  T.MODELO, T.ANOFAB, TT.DSCTIPOV                
    FROM TRANSPORT AS T 
	LEFT JOIN TYPETRANS AS TT ON TT.IDTIPO = T.TIPO
	WHERE 1=1 '
	
	IF @SEARCH_PATENTE IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.PATENTE LIKE ' + '''%' + @SEARCH_PATENTE + '%''' END
	IF @SEARCH_MARCA IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MARCA LIKE ' + '''%' + @SEARCH_MARCA + '%''' END
	IF @SEARCH_MODELO IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.MODELO LIKE ' + '''%' + @SEARCH_MODELO + '%''' END
	IF @SEARCH_TIPO IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND TT.TIPO LIKE ' + '''%' + @SEARCH_TIPO + '%''' END
	IF @SEARCH_ANOFAB IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND T.ANOFAB LIKE ' + '''%' + @SEARCH_ANOFAB + '%''' END

	IF @SORT_COLUMN='0' BEGIN SET @QUERY = @QUERY + ' ORDER BY T.PATENTE ' +  @SORT_DIRECTION END   
   IF @SORT_COLUMN='1' BEGIN SET @QUERY = @QUERY + ' ORDER BY T.MARCA ' + @SORT_DIRECTION END   
   IF @SORT_COLUMN='2' BEGIN SET @QUERY = @QUERY + ' ORDER BY T.MODELO '  + @SORT_DIRECTION END 
   IF @SORT_COLUMN='3' BEGIN SET @QUERY = @QUERY + ' ORDER BY TT.TIPO ' + @SORT_DIRECTION END
   IF @SORT_COLUMN='4' BEGIN SET @QUERY = @QUERY + ' ORDER BY T.ANOFAB ' + @SORT_DIRECTION END

	SET @QUERY = @QUERY + ' OFFSET ' + CAST(@IDISPLAYSTART AS VARCHAR) + ' ROWS FETCH NEXT ' + CAST(@IDISPLAYLENGTH AS VARCHAR) + ' ROWS ONLY'

	EXEC(@QUERY)

END 
