CREATE PROCEDURE [dbo].[V4MVC_DOCS_FEC_WORKERS_SELECT_FECHADOCUMENTO_CTTA]
(@RUT			NVARCHAR(10) = NULL
,@DIVCOD		NVARCHAR(20) = NULL 
,@IDEMPRESA		NVARCHAR(10) = NULL
,@ID_DOC_FEC	INT = NULL) AS
BEGIN
	DECLARE @EMP_COMUN INT
	DECLARE @DIV_COMUN INT
	SELECT @EMP_COMUN = D.COMUN 
		, @DIV_COMUN = DF.COMUN 
	FROM DOCS_FEC AS DF 
	INNER JOIN DOCS AS D ON DF.ID_DOC_DEPEND = D.ID_DOC 
	WHERE (DF.ID_DOC_FEC = @ID_DOC_FEC)
	PRINT @EMP_COMUN
	PRINT @DIV_COMUN

	IF(@EMP_COMUN IS NOT NULL AND @EMP_COMUN IS NOT NULL)
		BEGIN
			IF(@EMP_COMUN = 0)
				BEGIN
					IF(@EMP_COMUN =0)
						BEGIN
							SELECT TOP 1 FECHA 
							FROM DOCS_FEC_WORKERS 
							WHERE (RUT = @RUT) AND 
							(ID_DOC_FEC = @ID_DOC_FEC) AND 
							(DIVISION = @DIVCOD) AND 
							(EMPRESA = @IDEMPRESA)
							ORDER BY FECHA DESC
						END
					ELSE
						BEGIN
							SELECT TOP 1 FECHA 
							FROM DOCS_FEC_WORKERS 
							WHERE (RUT = @RUT) AND 
							(ID_DOC_FEC = @ID_DOC_FEC) AND 
							(EMPRESA = @IDEMPRESA)
							ORDER BY FECHA DESC
						END
				END
			ELSE
				BEGIN
					IF(@EMP_COMUN =0)
						BEGIN
							SELECT TOP 1 FECHA 
							FROM DOCS_FEC_WORKERS 
							WHERE (RUT = @RUT) AND 
							(ID_DOC_FEC = @ID_DOC_FEC) AND 
							(DIVISION = @DIVCOD)
							ORDER BY FECHA DESC
						END
					ELSE
						BEGIN
							SELECT TOP 1 FECHA 
							FROM DOCS_FEC_WORKERS 
							WHERE (RUT = @RUT) AND 
							(ID_DOC_FEC = @ID_DOC_FEC)
							ORDER BY FECHA DESC
						END
				END
		END
	ELSE
		BEGIN
			SELECT 'A' AS FECHA
		END
END

