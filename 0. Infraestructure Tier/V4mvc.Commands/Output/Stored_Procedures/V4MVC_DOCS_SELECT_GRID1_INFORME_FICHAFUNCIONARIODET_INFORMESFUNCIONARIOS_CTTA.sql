CREATE PROCEDURE [dbo].[V4MVC_DOCS_SELECT_GRID1_INFORME_FICHAFUNCIONARIODET_INFORMESFUNCIONARIOS_CTTA]
(
 @DIVCOD	NVARCHAR(4)	 = NULL,
 @TIPOPASE	NVARCHAR(9)	 = NULL,
 @RUT		NVARCHAR(10) = NULL,
 @IDEMPRESA	NVARCHAR(20)	= NULL
)
AS
BEGIN
SELECT DISTINCT 
CASE WHEN EXISTS(SELECT DISTINCT DTT.TIPOPASE FROM DOCS_TIPOPASE AS DTT INNER JOIN DOCS AS DD ON DTT.ID_DOC = DD.ID_DOC WHERE (DTT.DIVISION = @DIVCOD) AND (DTT.TIPOPASE = @TIPOPASE) AND (DD.ID_DOC_OPCION = 0) AND (DD.ID_DOC = D.ID_DOC) AND (DD.SUBEDOC = 'SI'))  THEN
	'(*) '+D.NOMBRE
ELSE
	'    '+D.NOMBRE
END AS NOMBRE,
		(CASE D.SUBEDOC WHEN 'SI' THEN
				CASE D.COMUN WHEN 1 THEN
							CASE WHEN EXISTS(SELECT TOP 1 ID, VALIDADO FROM DOCS_WORKERS WHERE (RUT = @RUT) AND (ID_DOC = D.ID_DOC) AND (DIVISION = (CASE WHEN D.COMUN_DIV = 'SI' THEN DIVISION ELSE @DIVCOD END )) ORDER BY ID_DOCS_WORKERS DESC)  THEN
								(SELECT TOP 1 VALIDADO FROM DOCS_WORKERS WHERE (RUT = @RUT) AND (ID_DOC = D.ID_DOC) AND (DIVISION = (CASE WHEN D.COMUN_DIV = 'SI' THEN DIVISION ELSE @DIVCOD END )) ORDER BY ID_DOCS_WORKERS DESC)
							ELSE
							    'NO EXISTE'
							END 
				 ELSE 
							CASE WHEN EXISTS(SELECT TOP 1 ID, VALIDADO FROM DOCS_WORKERS WHERE (RUT = @RUT) AND (ID_DOC = D.ID_DOC) AND (DIVISION = (CASE WHEN D.COMUN_DIV = 'SI' THEN DIVISION ELSE @DIVCOD END )) AND (EMPRESA = @IDEMPRESA) ORDER BY ID_DOCS_WORKERS DESC)  THEN
								(SELECT TOP 1 VALIDADO FROM DOCS_WORKERS WHERE (RUT = @RUT) AND (ID_DOC = D.ID_DOC) AND (DIVISION = (CASE WHEN D.COMUN_DIV = 'SI' THEN DIVISION ELSE @DIVCOD END )) AND (EMPRESA = @IDEMPRESA) ORDER BY ID_DOCS_WORKERS DESC)
							ELSE
								'NO EXISTE'
							END 
				 END
		 ELSE 
                    ''
		 END) AS ESTADO,
D.ID_DOC,		D.SUBEDOC,		D.ORDEN,
D.COMUN_DIV,	D.COMUN ,		D.CONFIDENCIAL,
--(SELECT TOP 1 ID_DOC_FEC FROM DOCS_FEC WHERE (ID_DOC_DEPEND = D.ID_DOC ) AND (ACTIVO = 'SI') AND VALIDO_MAYOR_HOY = 1 ORDER BY ORDEN), 
--(SELECT [dbo].[V4MVC_FN_GET_FECHA_WORKER_LOCAL]((SELECT TOP 1 ID_DOC_FEC FROM DOCS_FEC WHERE (ID_DOC_DEPEND = D.ID_DOC ) AND (ACTIVO = 'SI') AND VALIDO_MAYOR_HOY = 1 ORDER BY ORDEN),@RUT,@DIVCOD,@IDEMPRESA)) FECHAREG,
case  WHEN (SELECT [dbo].[V4MVC_FN_GET_FECHA_WORKER_LOCAL]((SELECT TOP 1 ID_DOC_FEC FROM DOCS_FEC WHERE (ID_DOC_DEPEND = D.ID_DOC ) AND (ACTIVO = 'SI') AND VALIDO_MAYOR_HOY = 1 ORDER BY ORDEN),@RUT,@DIVCOD,@IDEMPRESA)) < GETDATE() THEN 'SI'
      ELSE 'NO'   
   END AS FECHA_MENOR
FROM  DOCS AS D INNER JOIN  DOCS_TIPOPASE AS DT ON D.ID_DOC = DT.ID_DOC  
WHERE (D.ACTIVO = 'SI') AND (D.ID_DOC_OPCION = 0) AND (DT.DIVISION = @DIVCOD)  
ORDER BY D.ORDEN
END
