CREATE PROCEDURE [dbo].[V4MVC_INFORME_CONTRATOSCARRANQUE_HISTORIAL_CTTA]
(
 @OST			NVARCHAR(50) = NULL
,@MADRE			NVARCHAR(10) = NULL
,@EMPRESA		NVARCHAR(10) = NULL
,@NIVEL			INT = NULL
,@ID_DOC		INT = NULL
)
AS
BEGIN

		SELECT   L.VALIDADO_ADMINOST AS VALIDADO
				,A2.ID AS IDVAL
				,A2.NOMBRE AS ARCHIVOVAL
				,D.NOMBRE AS DOC
				,L.CERTUSUARIO_ADMINOST AS CERTUSUARIO
				,(SELECT NOMBRES + ' ' + APELLIDOS FROM WORKERS WHERE RUT=L.CERTUSUARIO_ADMINOST) AS VALIDADOR_FNOMBRES
				,L.OBS_RE_ADMINOST AS OBSFASE1
				,A.NOMBRE AS ARCHIVO_FASE1
				,A.ID AS IDARCHIVO_FASE1
				,L.CERTFECHA_ADMINOST AS FECHAFASE_1
				,L.CERTHORA_ADMINOST AS HORAFASE_1
				,'FASE 1' AS FASE
		FROM LOG_DOCS_OST2 L  
		INNER JOIN DOCS D ON D.ID_DOC=L.ID_DOC 
		INNER JOIN ARCHIVOS A2 ON A2.ID=L.ID_ARCHIVO 
		LEFT JOIN ARCHIVOS A ON A.ID = L.IDARCH_RE_ADMIN  
		WHERE  
		(OST = @OST) 
		AND (MADRE = @MADRE) 
		AND (EMPRESA = @EMPRESA)  
		AND (NIVEL = @NIVEL) 
		AND L.ID_DOC = @ID_DOC
		AND VALIDADO_ADMINOST IN ('SI','RE') 
		UNION 
		SELECT		L.VALIDADO 
					,A2.ID AS IDVAL
					,A2.NOMBRE AS ARCHIVOVAL
					,D.NOMBRE AS DOC
					,L.CERTUSUARIO AS CERTUSUARIO 
					,(SELECT NOMBRES + ' ' + APELLIDOS FROM WORKERS WHERE RUT=L.CERTUSUARIO) AS VALIDADOR_FNOMBRES
					,L.OBS_RE_VALIDADOR AS OBSFASE1
					,A.NOMBRE AS ARCHIVO_FASE1
					,A.ID AS IDARCHIVO_FASE1
					,L.CERTFECHA AS FECHAFASE_1
					,L.CERTHORA AS HORAFASE_1
					,'FASE 2' AS FASE
		FROM LOG_DOCS_OST2 L  
		INNER JOIN DOCS D ON D.ID_DOC=L.ID_DOC 
		INNER JOIN ARCHIVOS A2 ON A2.ID=L.ID_ARCHIVO 
		LEFT JOIN ARCHIVOS A ON A.ID = L.IDARCH_RE_VALIDADOR  
		WHERE 
		(OST = @OST) 
		AND (MADRE = @MADRE) 
		AND (EMPRESA = @EMPRESA)  
		AND (NIVEL = @NIVEL) 
		AND L.ID_DOC = @ID_DOC
		AND VALIDADO IN ('SI','RE') 
		ORDER BY FECHAFASE_1,HORAFASE_1,FASE DESC

END

--EXEC V4MVC_INFORME_CONTRATOSCARRANQUE_HISTORIAL_CTTA '20200227','777629409','761264907',0,130
