CREATE PROCEDURE [dbo].[V4MVC_INFORME_CONTRATOSCARRANQUE_DOCS_OST2_CTTA]
(
 @EMPRESA	NVARCHAR(10) = NULL
,@MADRE		NVARCHAR(10) = NULL
,@NIVEL		INT			 = NULL
,@OST		NVARCHAR(14) = NULL
)
AS
BEGIN

	SELECT DC.OST,D.ID_DOC,D.NOMBRE AS DOC
		,(CASE WHEN ISNULL(VALIDADO_ADMINOST,'NO')='NO' THEN 'Pendiente'
				ELSE (CASE WHEN ISNULL(VALIDADO_ADMINOST,'NO')='SI' THEN 'Aprobado' ELSE 'Rechazado' END) END) VALIDADOFASE1
		,DC.CERTUSUARIO_ADMINOST
		,(SELECT NOMBRES + ' ' + APELLIDOS FROM WORKERS WHERE RUT = DC.CERTUSUARIO_ADMINOST) AS F1_NOMBRE_VALIDADOR
		,DC.CERTFECHA_ADMINOST
		,DC.CERTHORA_ADMINOST
		,DC.OBS_RE_ADMINOST
		,DC.IDARCH_RE_ADMIN
		,A.NOMBRE AS NOMBREARCHFASE1
		,(CASE WHEN ISNULL(VALIDADO,'NO')='NO' THEN 'Pendiente'
				ELSE (CASE WHEN ISNULL(VALIDADO,'NO')='SI' THEN 'Aprobado' ELSE 'Rechazado' END) END) VALIDADOFASE2
		,DC.CERTUSUARIO
		,(SELECT NOMBRES + ' ' + APELLIDOS FROM WORKERS WHERE RUT = DC.CERTUSUARIO) AS F2_NOMBRE_VALIDADOR
		,DC.CERTFECHA
		,DC.CERTHORA
		,DC.OBS_RE_VALIDADOR
		,DC.IDARCH_RE_VALIDADOR
		,A2.NOMBRE AS NOMBREARCHFASE2
		,DC.FECHASUBE
		,DC.HORASUBE
		FROM DOCS_OST2 DC
			LEFT JOIN DOCS D ON D.ID_DOC = DC.ID_DOC
			LEFT JOIN ARCHIVOS A ON A.ID=DC.IDARCH_RE_ADMIN
			LEFT JOIN ARCHIVOS A2 ON A2.ID=DC.IDARCH_RE_VALIDADOR
		WHERE DC.EMPRESA=ISNULL(@EMPRESA,DC.EMPRESA)
		AND DC.MADRE=ISNULL(@MADRE,DC.MADRE)
		AND DC.NIVEL=ISNULL(@NIVEL,DC.NIVEL) 
		AND DC.OST= ISNULL(@OST,DC.OST) 

END


--EXEC V4MVC_INFORME_CONTRATOSCARRANQUE_DOCS_OST2_CTTA '761264907',NULL,NULL,null
