CREATE PROCEDURE [dbo].[V4MVC_DOC_FEC_VEHICULOS_CTTA]
(@ID_DOC			INT = NULL
,@PATENTE			NVARCHAR(6) = NULL
,@IDEMPRESA			NVARCHAR(11) = NULL
,@DIVCOD			NVARCHAR(4) = NULL)
AS
BEGIN

	SELECT DF.ID_DOC_FEC, DF.NOMBRE , '19000101' AS FECHA , 0 AS VALIDO_MAYOR_HOY , [dbo].[hoy](GETDATE()) AS FECHAHOY
	INTO #TEMP
	FROM DOCS_FEC AS DF
	WHERE 
	(DF.ID_DOC_DEPEND =  @ID_DOC) AND 
	(ACTIVO = 'SI') ORDER BY ORDEN ASC

	DECLARE @ID_DOC_FEC			INT,
			@NOMBRE		NVARCHAR(100),
			@FECHA			NVARCHAR(8),
			@VALIDO_MAYOR_HOY INT 
	DECLARE Fechas_DocsCtta CURSOR FOR
	SELECT ID_DOC_FEC , NOMBRE , FECHA , VALIDO_MAYOR_HOY  FROM #TEMP 
	OPEN Fechas_DocsCtta

	FETCH Fechas_DocsCtta INTO    @ID_DOC_FEC , @NOMBRE , @FECHA , @VALIDO_MAYOR_HOY

	WHILE (@@FETCH_STATUS = 0 )
		BEGIN
			DECLARE @EMP_COMUN INT = 0
			DECLARE @DIV_COMUN INT = 0
			SELECT @EMP_COMUN = D.COMUN 
				 , @DIV_COMUN = DF.COMUN  
			FROM DOCS_FEC AS DF 
			INNER JOIN DOCS AS D ON DF.ID_DOC_DEPEND = D.ID_DOC 
			WHERE  (DF.ID_DOC_FEC = @ID_DOC_FEC)

			DECLARE @VAL_FECHA NVARCHAR(8) = ''
			IF(@EMP_COMUN = 0)
				BEGIN
					IF(@DIV_COMUN = 0)
						BEGIN
							SELECT TOP 1 @VAL_FECHA = FECHA FROM DOCS_FEC_WORKERS WHERE (RUT = @PATENTE ) AND (ID_DOC_FEC = @ID_DOC_FEC) AND (DIVISION = @DIVCOD OR ISNULL(DIVISION,'AA') = 'AA') AND EMPRESA = @IDEMPRESA
						END
					ELSE
						BEGIN
							SELECT TOP 1 @VAL_FECHA = FECHA FROM DOCS_FEC_WORKERS WHERE (RUT = @PATENTE) AND (ID_DOC_FEC = @ID_DOC_FEC) AND EMPRESA = @IDEMPRESA
						END
				END
			ELSE
				BEGIN
					IF(@DIV_COMUN = 0)
						BEGIN
							SELECT TOP 1 @VAL_FECHA = FECHA FROM DOCS_FEC_WORKERS WHERE (RUT = @PATENTE) AND (ID_DOC_FEC = @ID_DOC_FEC) AND (DIVISION = @DIVCOD OR ISNULL(DIVISION,'AA') = 'AA')
						END
					ELSE 
						BEGIN
							SELECT TOP 1 @VAL_FECHA = FECHA FROM DOCS_FEC_WORKERS WHERE (RUT = @PATENTE) AND (ID_DOC_FEC = @ID_DOC_FEC)
						END
				END
			
			UPDATE #TEMP SET FECHA = @VAL_FECHA
							, VALIDO_MAYOR_HOY = ISNULL((SELECT VALIDO_MAYOR_HOY FROM DOCS_FEC WHERE (ID_DOC_FEC = @ID_DOC_FEC)),0)
			WHERE ID_DOC_FEC = @ID_DOC_FEC

			FETCH Fechas_DocsCtta INTO @ID_DOC_FEC , @NOMBRE , @FECHA , @VALIDO_MAYOR_HOY

		END
	CLOSE Fechas_DocsCtta
	DEALLOCATE Fechas_DocsCtta

	SELECT *  FROM #TEMP
END
