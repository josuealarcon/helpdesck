CREATE PROCEDURE [dbo].[V4MVC_CHECKINGINGHEAD_SELECT_INFORME_CHECKLIST_PORPERIODOS_INFORME_CHECKLIST_CTTA]
(
@ID_CHECK INT = NULL,
@FECHAINI  NVARCHAR(7)       = NULL,
@FECHAFIN  NVARCHAR(7)       = NULL,
@EMPRESA  NVARCHAR(10)       = NULL
) AS
BEGIN
DECLARE @FECHA_INI DATE
DECLARE @FECHA_FIN DATE
--SET @FECHA_INI = @FECHAINI + '01'
--SET @FECHA_FIN = @FECHAFIN + '01'
SET @FECHA_INI = SUBSTRING(@FECHAINI,1,4) +SUBSTRING(@FECHAINI,6,2)+ '01'
SET @FECHA_FIN = SUBSTRING(@FECHAFIN,1,4) +SUBSTRING(@FECHAFIN,6,2) + '01'

IF @ID_CHECK = 1--TFS
BEGIN

 ;WITH vw AS  
 (  
SELECT PERIODO, COUNT(*) AS TOTAL
FROM   
      ( 
      SELECT SUBSTRING(CHKNGH.FECHA,0,7)+'NO' AS PERIODO 
      FROM CHECK_CHECKINGINGHEAD CHKNGH 
      INNER JOIN [CHECK] CHK ON CHKNGH.ID_TIPO = CHK.ID_TIPO AND CHKNGH.ID_CHECK = CHK.ID_CHECK 
      INNER JOIN CHECK_TIPO TP ON CHK.ID_TIPO = TP.ID_TIPO 
      INNER JOIN WORKERS W ON CHKNGH.USRCREA = W.RUT 
      INNER JOIN TRANSPORT TR ON CHKNGH.IDENTIFICADOR = TR.PATENTE 
      INNER JOIN TYPETRANS TY ON TR.TIPO = TY.IDTIPO 
      WHERE (SELECT [dbo].[ValidaCheckListItems](CHKNGH.ID_TIPO,CHKNGH.ID_CHECK,CHKNGH.ID_CHECKING,CHKNGH.ID_CHECKINGHEAD))='NO' AND TR.EMPRESA <>''
	  AND (FECHA  BETWEEN @FECHAINI AND @FECHAFIN) 
	  AND TR.EMPRESA = @EMPRESA
	  AND W.EMPRESA = @EMPRESA
	  AND CHKNGH.ID_CHECK = @ID_CHECK
	  UNION ALL 
      SELECT SUBSTRING(CHKNGH.FECHA,0,7)+'SI' AS PERIODO 
      FROM CHECK_CHECKINGINGHEAD CHKNGH 
      INNER JOIN [CHECK] CHK ON CHKNGH.ID_TIPO = CHK.ID_TIPO AND CHKNGH.ID_CHECK = CHK.ID_CHECK 
      INNER JOIN CHECK_TIPO TP ON CHK.ID_TIPO = TP.ID_TIPO 
      INNER JOIN WORKERS W ON CHKNGH.USRCREA = W.RUT 
      INNER JOIN TRANSPORT TR ON CHKNGH.IDENTIFICADOR = TR.PATENTE 
      INNER JOIN TYPETRANS TY ON TR.TIPO = TY.IDTIPO 
      WHERE (SELECT [dbo].[ValidaCheckListItems](CHKNGH.ID_TIPO,CHKNGH.ID_CHECK,CHKNGH.ID_CHECKING,CHKNGH.ID_CHECKINGHEAD))='SI' AND TR.EMPRESA <>''
	  AND (FECHA  BETWEEN @FECHAINI AND @FECHAFIN) 
	  AND TR.EMPRESA = @EMPRESA
	  AND W.EMPRESA = @EMPRESA
	  AND CHKNGH.ID_CHECK = @ID_CHECK     
	  ) AS SourceTable GROUP BY PERIODO
)   
SELECT 
X.[Period] AS PERIODO
,ISNULL(t.TOTAL,0) AS TOTAL
FROM 
    (
	SELECT [Period] = SUBSTRING(CONVERT(VARCHAR(8),DATEADD(Day,Number,@FECHA_INI),112),0,7)+'NO'  
    FROM  master..spt_values  
    WHERE Type='P' 
    AND DATEADD(day,Number,@FECHA_INI) <= @FECHA_FIN
	UNION 
	SELECT [Period] = SUBSTRING(CONVERT(VARCHAR(8),DATEADD(Day,Number,@FECHA_INI),112),0,7)+'SI'  
    FROM  master..spt_values  
    WHERE Type='P' 
    AND DATEADD(day,Number,@FECHA_INI) <= @FECHA_FIN
	) AS X LEFT JOIN  vw t ON X.[Period] = t.PERIODO

END
ELSE
BEGIN

 ;WITH vw AS  
 (  
SELECT PERIODO, COUNT(*) AS TOTAL
FROM   
      ( 
         SELECT SUBSTRING(CHKNGH.FECHA,0,7)+'NO' AS PERIODO 
         FROM TYPETRANS AS TY  
         INNER JOIN TRANSPORT AS TR ON TY.IDTIPO = TR.TIPO  
         RIGHT OUTER JOIN CHECK_CHECKINGINGHEAD AS CHKNGH  
         INNER JOIN [CHECK] AS CHK ON CHKNGH.ID_TIPO = CHK.ID_TIPO AND CHKNGH.ID_CHECK = CHK.ID_CHECK  
         INNER JOIN CHECK_TIPO AS TP ON CHK.ID_TIPO = TP.ID_TIPO ON TR.PATENTE = CHKNGH.IDENTIFICADOR  
         LEFT OUTER JOIN ENTERPRISE AS E ON TR.EMPRESA = E.IDEMPRESA  
         WHERE (SELECT [dbo].[ValidaCheckListItems](CHKNGH.ID_TIPO,CHKNGH.ID_CHECK,CHKNGH.ID_CHECKING,CHKNGH.ID_CHECKINGHEAD))='NO' AND TR.EMPRESA <>'' 
     	 AND (FECHA  BETWEEN @FECHAINI AND @FECHAFIN) 
		 AND TR.EMPRESA = @EMPRESA
	     AND CHKNGH.ID_CHECK = @ID_CHECK 
         UNION ALL 
         SELECT SUBSTRING(CHKNGH.FECHA,0,7)+'SI' AS PERIODO 
         FROM TYPETRANS AS TY  
         INNER JOIN TRANSPORT AS TR ON TY.IDTIPO = TR.TIPO  
         RIGHT OUTER JOIN CHECK_CHECKINGINGHEAD AS CHKNGH  
         INNER JOIN [CHECK] AS CHK ON CHKNGH.ID_TIPO = CHK.ID_TIPO AND CHKNGH.ID_CHECK = CHK.ID_CHECK  
         INNER JOIN CHECK_TIPO AS TP ON CHK.ID_TIPO = TP.ID_TIPO ON TR.PATENTE = CHKNGH.IDENTIFICADOR  
         LEFT OUTER JOIN ENTERPRISE AS E ON TR.EMPRESA = E.IDEMPRESA  
         WHERE (SELECT [dbo].[ValidaCheckListItems](CHKNGH.ID_TIPO,CHKNGH.ID_CHECK,CHKNGH.ID_CHECKING,CHKNGH.ID_CHECKINGHEAD))='SI' AND TR.EMPRESA <>''
	     AND (FECHA  BETWEEN @FECHAINI AND @FECHAFIN)  
	     AND TR.EMPRESA = @EMPRESA
	     AND CHKNGH.ID_CHECK = @ID_CHECK   
	  ) AS SourceTable GROUP BY PERIODO
)   
SELECT 
X.[Period] AS PERIODO
,ISNULL(t.TOTAL,0) AS TOTAL
FROM 
    (
	SELECT [Period] = SUBSTRING(CONVERT(VARCHAR(8),DATEADD(Day,Number,@FECHA_INI),112),0,7)+'NO'  
    FROM  master..spt_values  
    WHERE Type='P' 
    AND DATEADD(day,Number,@FECHA_INI) <= @FECHA_FIN
	UNION 
	SELECT [Period] = SUBSTRING(CONVERT(VARCHAR(8),DATEADD(Day,Number,@FECHA_INI),112),0,7)+'SI'  
    FROM  master..spt_values  
    WHERE Type='P' 
    AND DATEADD(day,Number,@FECHA_INI) <= @FECHA_FIN
	) AS X LEFT JOIN  vw t ON X.[Period] = t.PERIODO

END

 
END	



