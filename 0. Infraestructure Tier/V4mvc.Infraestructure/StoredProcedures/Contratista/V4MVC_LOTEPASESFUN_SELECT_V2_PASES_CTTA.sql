CREATE PROCEDURE [dbo].[V4MVC_LOTEPASESFUN_SELECT_V2_PASES_CTTA]
(
  @IDPASE		INT
 ,@DIVCOD		NVARCHAR(4) = ''
 ,@ID_EMPRESA	NVARCHAR(10)
 ,@FEC_INI		NVARCHAR(8) = '19000101'
 ,@FEC_FIN		NVARCHAR(8) = '19000101'
) AS 
BEGIN
	
	SELECT
		SS.RUT AS PATENTE,
		SS.MARCA,
		SS.MODELO,
		SS.ANIO,
		SS.TIPOVEHI,
		COALESCE(
					(
						SELECT
							TOP 1
							TT.DSCTIPOV
						FROM TYPETRANS TT
						WHERE TT.IDTIPO = SS.TIPOVEHI
					),
				 '') AS TIPOVEHI_TXT,
		SS.SINOLT,
		SS.EMPRESA_VEH AS EMPRESA,
		COALESCE(
					(
						SELECT
							TOP 1
							E.ACRONIMO
						FROM ENTERPRISE E
						WHERE E.IDEMPRESA = SS.EMPRESA_VEH
					),
				 '') AS NOMBRE_EMPRESA,
		SS.PERTENECE_NOMINA AS NOMINA,
		SS.PASES_ACTIVOS
	FROM
	(
		SELECT
			LPF.RUTLOTE AS RUT,
			ISNULL(LPF.NOMBRESLT, '') AS MARCA,
			ISNULL(LPF.APELLIDOSLT, '') AS MODELO,
			ISNULL(LPF.FNACIMLT, '') AS ANIO,
			ISNULL(LPF.TIPOVEHI, 0) AS TIPOVEHI,
			ISNULL(LPF.SINOLT, '') AS SINOLT,
			ISNULL(LPF.EMPRESALT, '') AS EMPRESA_VEH,
			(CASE
				WHEN CONVERT(NVARCHAR(10), @ID_EMPRESA) = CONVERT(NVARCHAR(10), LPF.EMPRESALT) THEN 1
				ELSE 0 END
			) AS PERTENECE_NOMINA,
			(
			  SELECT COUNT(*)
			  FROM TRANSPORT_DIVISION_PASES TDP
			  WHERE 
					(TDP.PATENTE = LPF.RUTLOTE) AND
					(TDP.LOTE <> '0') AND
					(TDP.AUTOR = 'SI') AND
					(TDP.DIVISION = @DIVCOD) AND
					(TDP.LOTE <> @IDPASE) AND 
					(
					  (@FEC_INI BETWEEN TDP.FINIPASE AND TDP.FFINPASE) OR
					  (@FEC_FIN BETWEEN TDP.FINIPASE AND TDP.FFINPASE) OR
					  (@FEC_INI < TDP.FINIPASE AND TDP.FFINPASE < @FEC_FIN)
					)
			) AS PASES_ACTIVOS
		FROM LOTEPASESFUN LPF
		WHERE
			LPF.NLOTEPROC = @IDPASE AND
			LPF.TIPORUT = 'VEHICULO'
	) SS
END


