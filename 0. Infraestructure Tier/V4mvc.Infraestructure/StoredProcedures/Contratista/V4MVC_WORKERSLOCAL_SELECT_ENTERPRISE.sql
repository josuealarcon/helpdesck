CREATE PROCEDURE [dbo].[V4MVC_WORKERSLOCAL_SELECT_ENTERPRISE]       
(@IDEMPRESA            NVARCHAR(10) = NULL) AS       
BEGIN 

	DECLARE @MAXIMO INT           
	DECLARE @CONTADOR INT           
	DECLARE @DATO VARCHAR(10)          
	DECLARE @DATO2 VARCHAR  (10)          
	DECLARE @CONTADOR2 INT           
	DECLARE @MAXIMO2 INT           
          
	CREATE TABLE  #TEMP2 (          
	RUT VARCHAR(10)			COLLATE DATABASE_DEFAULT NOT NULL,       
	DIVISION VARCHAR (3)	COLLATE DATABASE_DEFAULT NOT NULL         
	)          
          
	CREATE TABLE #FINAL (          
	AUTOR VARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,          
	VALIDO VARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,          
	DIVISION VARCHAR (2)	 COLLATE DATABASE_DEFAULT NOT NULL          
	)         
  
	CREATE TABLE #ACREDITADOS (  
	SI_CANTIDAD INT,  
	DIVCOD VARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,
	SI_VALIDO VARCHAR(2)	 COLLATE DATABASE_DEFAULT NOT NULL
	)  
  
	CREATE TABLE #NO_ACREDITADOS (  
	NO_CANTIDAD INT,  
	DIVCOD VARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,
	NO_VALIDO VARCHAR(2)	 COLLATE DATABASE_DEFAULT NOT NULL
	)  
          
          
	SELECT           
	DISTINCT D.DIVCOD, D.DIVISION into #temp1          
	FROM WORKERSLOCAL WL WITH (NOLOCK)          
	INNER JOIN A024_DIVISIONES D ON WL.DIVISION = D.DIVCOD           
	WHERE WL.EMPRESA = @IDEMPRESA  AND D.ACTIVO = 'SI'          
          
	select  ROW_NUMBER() OVER(ORDER BY DIVCOD ASC) AS id , * INTO #TEMPNUMERADO from           
	#temp1          
          
          
	SET @CONTADOR = 1          
          
	SELECT @MAXIMO = MAX(id) FROM  #TEMPNUMERADO          
          
          
	WHILE ( @CONTADOR <= @MAXIMO )           
	BEGIN                 
          
	SELECT @DATO = DIVCOD FROM #TEMPNUMERADO          
	WHERE id = @CONTADOR          
            
	INSERT INTO #TEMP2           
	SELECT DISTINCT RUT, DIVISION          
	FROM WORKERSLOCAL WITH (NOLOCK)
	WHERE EMPRESA =@IDEMPRESA AND DIVISION = @DATO          
             
	SET @CONTADOR = @CONTADOR +1           
	END          
                   
	select  ROW_NUMBER() OVER(ORDER BY RUT ASC) AS id , * INTO #TEMPNUMERADO2 from           
	#TEMP2          
          
	SELECT @MAXIMO2 = ID FROM #TEMPNUMERADO2          
	SET @CONTADOR2 = 1             
          
	 WHILE ( @CONTADOR2 <= @MAXIMO2 )          
	 BEGIN          
             
	  SELECT @DATO2 = RUT  ,@DATO = DIVISION FROM #TEMPNUMERADO2           
	  WHERE id = @CONTADOR2          
          
	  INSERT INTO #FINAL          
	  SELECT TOP 1 AUTOR, VALIDADO , DIVISION          
	  FROM WORKERSLOCAL   WITH (NOLOCK)        
	  WHERE EMPRESA = @IDEMPRESA AND DIVISION = @DATO AND RUT = @DATO2 ORDER BY LOTE          
          
	  SET @CONTADOR2 = @CONTADOR2 +1          
	 END          
        
	 INSERT INTO #NO_ACREDITADOS  
	 SELECT COUNT (*)AS CANTIDAD_NO ,DIVISION as CODIGO_DIV, 'NO' AS VALIDO FROM  #FINAL           
	 WHERE AUTOR != 'SI'          
	 OR VALIDO != 'SI'          
	 GROUP BY DIVISION   
  
	 INSERT INTO #ACREDITADOS         
	 SELECT COUNT (*)AS CANTIDAD_SI, DIVISION as CODIGO_DIV , 'SI' AS VALIDO FROM  #FINAL           
	 WHERE AUTOR = 'SI'          
	 AND VALIDO = 'SI'          
	 GROUP BY DIVISION     
   
	SELECT ISNULL(A.SI_CANTIDAD,0) AS SI_CANTIDAD, ISNULL(SI_VALIDO,'SI') AS SI_VALIDO,ISNULL(A.DIVCOD,B.DIVCOD) AS CODIGO_DIV,ISNULL(B.NO_CANTIDAD,0) AS NO_CANTIDAD, ISNULL(B.NO_VALIDO,'NO') AS NO_VALIDO  
	FROM #ACREDITADOS A  
	FULL JOIN #NO_ACREDITADOS B  
	ON A.DIVCOD = B.DIVCOD  
  
          
END 
