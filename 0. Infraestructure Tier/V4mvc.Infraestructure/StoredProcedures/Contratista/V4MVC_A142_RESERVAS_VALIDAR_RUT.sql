CREATE PROCEDURE [dbo].[V4MVC_A142_RESERVAS_VALIDAR_RUT]  
(  
 @RUT		NVARCHAR(10)	= NULL  
,@CURSO		INT				= NULL  
,@CODIGO	INT				= NULL  
,@FECHA		NVARCHAR(8)		= NULL
)  
AS  
BEGIN  
    
	DECLARE @A DATETIME  
	DECLARE @B DATETIME  
	DECLARE @C NVARCHAR(8)  
	DECLARE @FECHA_ANIO NVARCHAR(4)  
	DECLARE @VECES_REPROBO_ANIO INT  
	DECLARE @FECHA_FINAL NVARCHAR(8)  
	DECLARE @MENSAJE NVARCHAR(MAX)
  
	SET @A = CAST(@FECHA AS DATETIME)   
	SET @B = DATEADD(day, -14, @A)  
	SET @C = CONVERT(VARCHAR(8), @B, 112);  
	SET @FECHA_ANIO = SUBSTRING(@FECHA,1,4)  
  
	IF EXISTS(  
	SELECT * FROM A142_RESERVAS   
	WHERE RUT = @RUT   
	AND CURSO = @CURSO   
	AND ASISTIO = 'NO'   
	AND APROBO = 'NO'   
	AND FINALIZADO = 'SI'   
	AND FECHA BETWEEN @C AND @FECHA  
	)  
	BEGIN  
	SET  @MENSAJE = 'No puede reservar nuevamente para el mismo curso al que no asistio en periodo de ' + (SELECT VALOR FROM A036_CURSOPARAMETROS WHERE ID_PARAMETRO=1) +' Dias.'
	SELECT (@MENSAJE) AS MENSAJE
	END  
  
	SET @VECES_REPROBO_ANIO = (  
	SELECT COUNT(*) AS CUENTA FROM A142_RESERVAS   
	WHERE RUT = @RUT   
	AND CURSO= @CURSO   
	AND ASISTIO = 'NO'   
	AND APROBO = 'NO'   
	AND FINALIZADO = 'SI'   
	AND FECHA LIKE '%' + @FECHA_ANIO + '%'  
	)  

	IF(@VECES_REPROBO_ANIO >= (SELECT VALOR FROM A036_CURSOPARAMETROS WHERE ID_PARAMETRO=3))  
	BEGIN  
	SET @MENSAJE = 'No puede reservar para el mismo curso realizado y reprobado en el mismo aÃ±o mas de '+ (SELECT VALOR FROM A036_CURSOPARAMETROS WHERE ID_PARAMETRO=3) + ' veces'
	SELECT (@MENSAJE) AS MENSAJE
	END  
  
	SET @FECHA_FINAL = (  
	SELECT dbo.hoy(DATEADD(m,VENCIMIENTO,FECHA)) FROM A142_RESERVAS    
	WHERE (RUT= @RUT)   
	AND (APROBO = 'SI')   
	AND (CURSO= @CURSO)   
	AND (FINALIZADO = 'SI')    
	AND dbo.hoy(DATEADD(m,VENCIMIENTO - (SELECT VALOR FROM A036_CURSOPARAMETROS WHERE ID_PARAMETRO=2),FECHA)) > @FECHA  
	)
  
	IF(@FECHA_FINAL IS NOT NULL)  
	BEGIN  
	SET @MENSAJE = 'No puede reservar para el mismo curso realizado anteriormente que aun esta vigente hasta el '+  @FECHA_FINAL +' , puede reservar '+ (SELECT VALOR FROM A036_CURSOPARAMETROS WHERE ID_PARAMETRO=2) + ' mes(es) antes que cumpla el vencimiento.'
	SELECT (@MENSAJE) AS MENSAJE
	END  

END


