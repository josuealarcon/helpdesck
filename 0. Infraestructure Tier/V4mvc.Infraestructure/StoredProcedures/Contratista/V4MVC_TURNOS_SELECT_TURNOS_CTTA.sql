CREATE PROCEDURE [dbo].[V4MVC_TURNOS_SELECT_TURNOS_CTTA]
( @IDEMPRESA      NVARCHAR(11) = NULL ) AS
BEGIN
	SELECT T.IDTURNO							, T.TURNO			, T.EMPRESA				, T.DIATRABAJO
		 , T.DIADESCANSO						, T.TURDESCR		, T.OST					, ISNULL(T.ESTADOTUR,'PENDIENTE') AS ESTADOTUR 
		 , ISNULL(T.VALIDADO,'NO') AS VALIDADO	, CASE WHEN (SELECT COUNT(*) FROM CAL_TURNO WHERE TURNO = T.TURNO  AND EMPRESA = @IDEMPRESA) > 0 THEN 1 ELSE 0 END AS CALENDARIO,
		 COALESCE((
			SELECT TOP 1 TD.ID_DISPUTA
			FROM TURNOS_DISPUTA TD
			WHERE TD.IDTURNO = T.IDTURNO
			ORDER BY TD.ID_DISPUTA DESC
		 ), -1) AS DISP_IDDISPUTA,
		 COALESCE((
			SELECT TOP 1 TD.ESTADO
			FROM TURNOS_DISPUTA TD
			WHERE TD.IDTURNO = T.IDTURNO
			ORDER BY TD.ID_DISPUTA DESC
		 ), '') AS DISP_ESTADO
	FROM TURNOS T
	WHERE T.EMPRESA = @IDEMPRESA AND 
	T.VISIBLE = 'SI'  
	ORDER BY T.FECHAMOD DESC, T.HORAMOD DESC
END
