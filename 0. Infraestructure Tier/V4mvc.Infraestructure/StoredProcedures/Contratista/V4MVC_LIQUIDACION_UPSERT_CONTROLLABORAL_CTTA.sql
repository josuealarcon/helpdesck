CREATE PROCEDURE [dbo].[V4MVC_LIQUIDACION_UPSERT_CONTROLLABORAL_CTTA]
(
  @RUT				NVARCHAR(10)
 ,@FECHA			NVARCHAR(6)
 ,@EMPRESA			NVARCHAR(10)
 ,@USUARIO			NVARCHAR(10)
 ,@ID_ARCHIVO		UNIQUEIDENTIFIER
 ,@NOMBRE_ARCHIVO	NVARCHAR(50)
 ,@TIPO_CONTENIDO	NVARCHAR(20)
) AS
BEGIN
	DECLARE @LIQ_EXISTS BIT = 0
	DECLARE @LIQ_RUT NVARCHAR(10)
	DECLARE @LIQ_FECHA NVARCHAR(6)
	DECLARE @LIQ_NOMBRE_ARCHIVO NVARCHAR(50)
	DECLARE @LIQ_TIPO_CONTENIDO NVARCHAR(20)
	DECLARE @LIQ_ARCHIVO VARBINARY(MAX)
	DECLARE @LIQ_FECHASUBE NVARCHAR(8)
	DECLARE @LIQ_HORASUBE NVARCHAR(8)
	DECLARE @LIQ_USUARIO NVARCHAR(10)
	DECLARE @LIQ_VALIDADO NVARCHAR(2)
	DECLARE @LIQ_CERTUSUARIO NVARCHAR(10)
	DECLARE @LIQ_CERTFECHA NVARCHAR(8)
	DECLARE @LIQ_CERTHORA NVARCHAR(8)
	DECLARE @LIQ_IDRECHAZO INT
	DECLARE @LIQ_ID UNIQUEIDENTIFIER
	DECLARE @LIQ_IMPONIBLE INT
	DECLARE @LIQ_LIQUIDO INT
	DECLARE @LIQ_TRANSFERIDO INT
	DECLARE @LIQ_EMPRESA NVARCHAR(10)
	DECLARE @LIQ_BONOIP INT
	DECLARE @LIQ_BONOIS INT
	DECLARE @LIQ_FECHACSV NVARCHAR(8)
	DECLARE @LIQ_HORACSV NVARCHAR(8)
	DECLARE @LIQ_USUARIOCSV NVARCHAR(10)

	DECLARE @CURR_FECHA NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 112) /* yyyymmdd */
	DECLARE @CURR_TIEMPOFULL NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 108) /* hh:mm:ss */

	SELECT
		TOP 1
		@LIQ_EXISTS = 1, 
		@LIQ_RUT = RUT,
		@LIQ_FECHA = FECHA,
		@LIQ_NOMBRE_ARCHIVO = NOMBRE_ARCHIVO,
		@LIQ_TIPO_CONTENIDO = TIPO_CONTENIDO,
		@LIQ_ARCHIVO = ARCHIVO,
		@LIQ_FECHASUBE = FECHASUBE,
		@LIQ_HORASUBE = HORASUBE,
		@LIQ_USUARIO = USUARIO,
		@LIQ_VALIDADO = VALIDADO,
		@LIQ_CERTUSUARIO = CERTUSUARIO,
		@LIQ_CERTFECHA = CERTFECHA,
		@LIQ_CERTHORA = CERTHORA,
		@LIQ_IDRECHAZO = IDRECHAZO,
		@LIQ_ID = ID,
		@LIQ_IMPONIBLE = IMPONIBLE,
		@LIQ_LIQUIDO = LIQUIDO,
		@LIQ_TRANSFERIDO = TRANSFERIDO,
		@LIQ_EMPRESA = EMPRESA,
		@LIQ_BONOIP = BONOIP,
		@LIQ_BONOIS = BONOIS,
		@LIQ_FECHACSV = FECHACSV,
		@LIQ_HORACSV = HORACSV,
		@LIQ_USUARIOCSV = USUARIOCSV
	FROM LIQUIDACION
	WHERE
		RUT = @RUT AND
		FECHA = @FECHA AND
		EMPRESA = @EMPRESA

	IF(@LIQ_EXISTS = 0)
		BEGIN
			INSERT INTO LIQUIDACION
						(
							RUT,
							FECHA,
							ARCHIVO,
							NOMBRE_ARCHIVO,
							TIPO_CONTENIDO,
							FECHASUBE,
							HORASUBE,
							ID,
							USUARIO,
							VALIDADO,
							EMPRESA
						)
			VALUES		(
							@RUT,
							@FECHA,
							NULL,
							@NOMBRE_ARCHIVO,
							@TIPO_CONTENIDO,
							@CURR_FECHA,
							@CURR_TIEMPOFULL,
							@ID_ARCHIVO,
							@USUARIO,
							'NO',
							@EMPRESA
						)
		END
	ELSE
		BEGIN
			INSERT INTO LIQUIDACION_LOG
						(
							RUT,
							FECHA,
							NOMBRE_ARCHIVO,
							TIPO_CONTENIDO,
							ARCHIVO,
							FECHASUBE,
							HORASUBE,
							USUARIO,
							VALIDADO,
							CERTUSUARIO,
							CERTFECHA,
							CERTHORA,
							IDRECHAZO,
							ID,
							IMPONIBLE,
							LIQUIDO,
							TRANSFERIDO,
							EMPRESA,
							BONOIP,
							BONOIS,
							FECHACSV,
							HORACSV,
							USUARIOCSV,
							USUARIODEL,
							FECHADEL,
							HORADEL
						)
			 VALUES
						(
							@LIQ_RUT,
							@LIQ_FECHA,
							@LIQ_NOMBRE_ARCHIVO,
							@LIQ_TIPO_CONTENIDO,
							@LIQ_ARCHIVO,
							@LIQ_FECHASUBE,
							@LIQ_HORASUBE,
							@LIQ_USUARIO,
							@LIQ_VALIDADO,
							@LIQ_CERTUSUARIO,
							@LIQ_CERTFECHA,
							@LIQ_CERTHORA,
							@LIQ_IDRECHAZO,
							@LIQ_ID,
							@LIQ_IMPONIBLE,
							@LIQ_LIQUIDO,
							@LIQ_TRANSFERIDO,
							@LIQ_EMPRESA,
							@LIQ_BONOIP,
							@LIQ_BONOIS,
							@LIQ_FECHACSV,
							@LIQ_HORACSV,
							@LIQ_USUARIOCSV,
							@USUARIO,
							@CURR_FECHA,
							@CURR_TIEMPOFULL
						)

			UPDATE LIQUIDACION
			SET
				NOMBRE_ARCHIVO = @NOMBRE_ARCHIVO,
				TIPO_CONTENIDO = @TIPO_CONTENIDO,
				ID = @ID_ARCHIVO,
				USUARIO = @USUARIO,
				FECHASUBE = @CURR_FECHA,
				HORASUBE = @CURR_TIEMPOFULL,
				VALIDADO = 'NO'
			WHERE
				RUT = @RUT AND
				FECHA = @FECHA AND
				EMPRESA = @EMPRESA
		END
END
