CREATE PROCEDURE [dbo].[V4MVC_A056_FORM301_UPDATE_V2_CONTROLLABORAL_CTTA]
(
  @EMPRESA				NVARCHAR(10)
 ,@PERIODO				NVARCHAR(6)
 ,@DIVISION				NVARCHAR(4)
 ,@OST					NVARCHAR(50)
 ,@USUARIO				NVARCHAR(10)
 ,@DISPUTA_ID			INT
 ,@ID_CERTIFICADO		INT
 ,@ID					UNIQUEIDENTIFIER
 ,@DISPUTA_EXISTE		INT OUTPUT
 ,@DISPUTA_EMPRESA		NVARCHAR(12) OUTPUT
 ,@DISPUTA_FECHA		NVARCHAR(8) OUTPUT
) AS
BEGIN
	DECLARE @CURR_FECHA NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 112) /* yyyymmdd */
	DECLARE @CURR_TIEMPOFULL NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 108) /* hh:mm:ss */

	DECLARE @DDC_ID_DISPUTA INT
	DECLARE @DDC_ID_DOC INT
	DECLARE @DDC_ID UNIQUEIDENTIFIER
	DECLARE @DDC_USUARIO NVARCHAR(10)
	DECLARE @DDC_HORA NVARCHAR(8)
	DECLARE @DDC_OBSERVACION NVARCHAR(1000)
	DECLARE @DDC_CERTUSUARIO NVARCHAR(10)
	DECLARE @DDC_CERTFECHA NVARCHAR(8)
	DECLARE @DDC_CERTHORA NVARCHAR(8)
	DECLARE @DDC_ESTADO NVARCHAR(2)
	DECLARE @DDC_REVALUSUARIO NVARCHAR(10)
	DECLARE @DDC_REVALFECHA NVARCHAR(8)
	DECLARE @DDC_REVALHORA NVARCHAR(8)
	DECLARE @DDC_OBSERVACION_REVAL NVARCHAR(1000)
	DECLARE @DDC_VALIDADO NVARCHAR(2)
	DECLARE @DDC_PERIODO NVARCHAR(6)
	DECLARE @DDC_ID_CERTIFICADO INT
	
	DECLARE @AF_EXISTE BIT = 0
	DECLARE @AF_ID_CERTIFICADO	INT
	DECLARE @AF_EMPRESA	NVARCHAR(10)
	DECLARE @AF_REGION	NVARCHAR(5)
	DECLARE @AF_INSPECCION	NVARCHAR(4)
	DECLARE @AF_ANIO	INT
	DECLARE @AF_CERTIFICADO	BIGINT
	DECLARE @AF_CLAVE	NVARCHAR(50)
	DECLARE @AF_TRA_DECL	INT
	DECLARE @AF_TRA_DESV	INT
	DECLARE @AF_TRA_VIGE	INT
	DECLARE @AF_COT_PAG		NVARCHAR(1)
	DECLARE @AF_COT_NPAG	NVARCHAR(1)
	DECLARE @AF_ADJ_NOM		NVARCHAR(1)
	DECLARE @AF_IND_AP_P	INT
	DECLARE @AF_IND_AP_MTO	INT
	DECLARE @AF_IND_AP_NP	INT
	DECLARE @AF_IND_AS_P	INT
	DECLARE @AF_IND_AS_MTO	INT
	DECLARE @AF_IND_AS_NP	INT
	DECLARE @AF_PERIODO_INI	NVARCHAR(6)
	DECLARE @AF_PERIODO_FIN	NVARCHAR(6)
	DECLARE @AF_FECHAMOD	NVARCHAR(8)
	DECLARE @AF_HORAMOD		NVARCHAR(8)
	DECLARE @AF_QUIEN		NVARCHAR(10)
	DECLARE @AF_VALIDADO	NVARCHAR(2)
	DECLARE @AF_ID_DOC		INT
	DECLARE @AF_OBSERVACION	NVARCHAR(500)
	DECLARE @AF_ID			UNIQUEIDENTIFIER
	DECLARE @AF_PERIODO		NVARCHAR(6)
	DECLARE @AF_USUARIO		NVARCHAR(10)
	DECLARE @AF_FECHASUBE	NVARCHAR(8)
	DECLARE @AF_HORASUBE	NVARCHAR(8)
	DECLARE @AF_CERTUSUARIO	NVARCHAR(10)
	DECLARE @AF_CERTFECHA	NVARCHAR(8)
	DECLARE @AF_CERTHORA	NVARCHAR(8)
	DECLARE @AF_OST			NVARCHAR(50)
	DECLARE @AF_DIVISION	NVARCHAR(4)

	SET @DISPUTA_EXISTE = 0

	SELECT
		@AF_EXISTE = 1,
		@AF_ID_CERTIFICADO = ID_CERTIFICADO,
		@AF_EMPRESA = EMPRESA,
		@AF_REGION = REGION,
		@AF_INSPECCION = INSPECCION,
		@AF_ANIO = ANIO,
		@AF_CERTIFICADO = CERTIFICADO,
		@AF_CLAVE = CLAVE,
		@AF_TRA_DECL = TRA_DECL,
		@AF_TRA_DESV = TRA_DESV,
		@AF_TRA_VIGE = TRA_VIGE,
		@AF_COT_PAG = COT_PAG,
		@AF_COT_NPAG = COT_NPAG,
		@AF_ADJ_NOM = ADJ_NOM,
		@AF_IND_AP_P = IND_AP_P,
		@AF_IND_AP_MTO = IND_AP_MTO,
		@AF_IND_AP_NP = IND_AP_NP,
		@AF_IND_AS_P = IND_AS_P,
		@AF_IND_AS_MTO = IND_AS_MTO,
		@AF_IND_AS_NP = IND_AS_NP,
		@AF_PERIODO_INI = PERIODO_INI,
		@AF_PERIODO_FIN = PERIODO_FIN,
		@AF_FECHAMOD = FECHAMOD,
		@AF_HORAMOD = HORAMOD,
		@AF_QUIEN = QUIEN,
		@AF_VALIDADO = VALIDADO,
		@AF_ID_DOC = ID_DOC,
		@AF_OBSERVACION = OBSERVACION,
		@AF_ID = ID,
		@AF_PERIODO = PERIODO,
		@AF_USUARIO = USUARIO,
		@AF_FECHASUBE = FECHASUBE,
		@AF_HORASUBE = HORASUBE,
		@AF_CERTUSUARIO = CERTUSUARIO,
		@AF_CERTFECHA = CERTFECHA,
		@AF_CERTHORA = CERTHORA,
		@AF_OST = OST,
		@AF_DIVISION = DIVISION
	FROM A056_FORM301
	WHERE
		(EMPRESA = @EMPRESA) AND
		(ID_CERTIFICADO = @ID_CERTIFICADO)

	IF(@AF_EXISTE = 1)
		BEGIN
			INSERT INTO A056_FORM301_LOG
							(
								ID_CERTIFICADO,
								EMPRESA,
								REGION,
								INSPECCION,
								ANIO,
								CERTIFICADO,
								CLAVE,
								TRA_DECL,
								TRA_DESV,
								TRA_VIGE,
								COT_PAG,
								COT_NPAG,
								ADJ_NOM,
								IND_AP_P,
								IND_AP_MTO,
								IND_AP_NP,
								IND_AS_P,
								IND_AS_MTO,
								IND_AS_NP,
								PERIODO_INI,
								PERIODO_FIN,
								FECHAMOD,
								HORAMOD,
								QUIEN,
								VALIDADO,
								ID_DOC,
								OBSERVACION,
								ID,
								PERIODO,
								USUARIO,
								FECHASUBE,
								HORASUBE,
								CERTUSUARIO,
								CERTFECHA,
								CERTHORA,
								OST,
								USUARIODEL,
								FECHADEL,
								HORADEL,
								DIVISION
							)
					VALUES (
								@AF_ID_CERTIFICADO,
								@AF_EMPRESA,
								@AF_REGION,
								@AF_INSPECCION,
								@AF_ANIO,
								@AF_CERTIFICADO,
								@AF_CLAVE,
								@AF_TRA_DECL,
								@AF_TRA_DESV,
								@AF_TRA_VIGE,
								@AF_COT_PAG,
								@AF_COT_NPAG,
								@AF_ADJ_NOM,
								@AF_IND_AP_P,
								@AF_IND_AP_MTO,
								@AF_IND_AP_NP,
								@AF_IND_AS_P,
								@AF_IND_AS_MTO,
								@AF_IND_AS_NP,
								@AF_PERIODO_INI,
								@AF_PERIODO_FIN,
								@AF_FECHAMOD,
								@AF_HORAMOD,
								@AF_QUIEN,
								@AF_VALIDADO,
								@AF_ID_DOC,
								@AF_OBSERVACION,
								@AF_ID,
								@AF_PERIODO,
								@AF_USUARIO,
								@AF_FECHASUBE,
								@AF_HORASUBE,
								@AF_CERTUSUARIO,
								@AF_CERTFECHA,
								@AF_CERTHORA,
								@AF_OST,
								@USUARIO,
								@CURR_FECHA,
								@CURR_TIEMPOFULL,
								@AF_DIVISION
							)
		END

	SELECT
		TOP 1
		@DISPUTA_EXISTE = 1,
		@DDC_ID_DISPUTA = ID_DISPUTA,
		@DISPUTA_EMPRESA = EMPRESA,
		@DDC_ID_DOC = ID_DOC,
		@DDC_ID = ID,
		@DDC_USUARIO = USUARIO,
		@DISPUTA_FECHA = FECHA,
		@DDC_HORA = HORA,
		@DDC_OBSERVACION = OBSERVACION,
		@DDC_CERTUSUARIO = CERTUSUARIO,
		@DDC_CERTFECHA = CERTFECHA,
		@DDC_CERTHORA = CERTHORA,
		@DDC_ESTADO = ESTADO,
		@DDC_REVALUSUARIO = REVALUSUARIO,
		@DDC_REVALFECHA = REVALFECHA,
		@DDC_REVALHORA = REVALHORA,
		@DDC_OBSERVACION_REVAL = OBSERVACION_REVAL,
		@DDC_VALIDADO = VALIDADO,
		@DDC_PERIODO = PERIODO,
		@DDC_ID_CERTIFICADO = ID_CERTIFICADO
	FROM DOCS_DISPUTA_CLABORAL
	WHERE
		ID_DISPUTA = @DISPUTA_ID AND
		ESTADO = 'NO'

	IF(@DISPUTA_EXISTE = 1)
		BEGIN
			INSERT INTO DOCS_DISPUTA_CLABORAL_LOG
				(
					ID_DISPUTA,
					EMPRESA,
					ID_DOC,
					ID,
					USUARIO,
					FECHA,
					HORA,
					OBSERVACION,
					CERTUSUARIO,
					CERTFECHA,
					CERTHORA,
					ESTADO,
					REVALUSUARIO,
					REVALFECHA,
					REVALHORA,
					OBSERVACION_REVAL,
					VALIDADO,
					PERIODO,
					ID_CERTIFICADO,
					USRMOD,
					FECHAMOD,
					HORAMOD,
					ACCION
				)
			VALUES 
				(
					@DDC_ID_DISPUTA,
					@DISPUTA_EMPRESA,
					@DDC_ID_DOC,
					@DDC_ID,
					@DDC_USUARIO,
					@DISPUTA_FECHA,
					@DDC_HORA,
					@DDC_OBSERVACION,
					@DDC_CERTUSUARIO,
					@DDC_CERTFECHA,
					@DDC_CERTHORA,
					@DDC_ESTADO,
					@DDC_REVALUSUARIO,
					@DDC_REVALFECHA,
					@DDC_REVALHORA,
					@DDC_OBSERVACION_REVAL,
					@DDC_VALIDADO,
					@DDC_PERIODO,
					@DDC_ID_CERTIFICADO,
					@USUARIO,
					@CURR_FECHA,
					@CURR_TIEMPOFULL,
					'ELIMINADO'
				)

			DELETE DOCS_DISPUTA_CLABORAL
			WHERE
				ID_DISPUTA = @DISPUTA_ID AND
				ESTADO = 'NO'
		END

		DELETE FROM ARCHIVOS WHERE ID = @ID

		UPDATE A056_FORM301
		SET
			ID = NULL,
			VALIDADO = 'NO'
		WHERE
			EMPRESA = @EMPRESA AND
			ID_CERTIFICADO = @ID_CERTIFICADO AND
			PERIODO = @PERIODO AND
			DIVISION = @DIVISION AND
			OST = @OST

END
