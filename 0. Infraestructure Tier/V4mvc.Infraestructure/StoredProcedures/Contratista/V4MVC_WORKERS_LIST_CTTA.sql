CREATE PROCEDURE [dbo].[V4MVC_WORKERS_LIST_CTTA]
( @IDEMPRESA               nvarchar(10) = NULL ) AS
BEGIN
	DECLARE @HOY NVARCHAR(8)
	SET @HOY = dbo.hoy(GETDATE()) 
   SELECT RUT, NOMBRES, APELLIDOS
		, STUFF((    SELECT ',' + DP.DIVISION
                        FROM (SELECT DISTINCT W.DIVISION FROM WORKERSLOCAL AS W 
							, ENTERPRISE AS E
							WHERE  (W.AUTOR <> 'BL') 
							AND (W.RUT = WORKERS.RUT) 
							AND  (@HOY BETWEEN W.FINIPASE AND W.FFINPASE) 
							) AS DP
						ORDER BY DP.DIVISION
                        FOR XML PATH('')
                        ), 1, 1, '' ) AS DIVISIONES
		, STUFF((    SELECT ',' + EP.ACRONIMO
                        FROM (SELECT DISTINCT E.ACRONIMO FROM WORKERSLOCAL AS W 
						, ENTERPRISE AS E
                        WHERE  (W.AUTOR <> 'BL') 
						AND (W.RUT = WORKERS.RUT) 
						AND  (@HOY BETWEEN W.FINIPASE AND W.FFINPASE) 
						AND (W.EMPRESA = E.IDEMPRESA) ) AS EP
						ORDER BY EP.ACRONIMO
                        FOR XML PATH('')
                        ), 1, 1, '' ) AS EMPRESAS
    FROM WORKERS 
    WHERE (RUT IN (SELECT DISTINCT W.RUT 
					FROM WORKERSLOCAL as W 
					WHERE W.FFINPASE > @HOY AND
					 (W.AUTOR <> 'BL') 
					AND (W.EMPRESA IN (SELECT O.EMPRESA 
										FROM OSTARBOL O 
										INNER JOIN OST ON OST.NROOST = O.OST 
										WHERE (O.MADRE = @IDEMPRESA OR O.EMPRESA = @IDEMPRESA))) 
					--AND (W.OST IN (SELECT O.OST 
									--FROM OSTARBOL O 
									--INNER JOIN OST ON OST.NROOST = O.OST 
									--WHERE (O.MADRE = @IDEMPRESA OR O.EMPRESA = @IDEMPRESA)) OR ISNULL(W.OST,'NOMINA') = 'NOMINA') 
					)) ORDER BY RUT ASC

END
