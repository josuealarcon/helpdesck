CREATE PROCEDURE [dbo].[V4MVC_COMBOPATENTE_CASCADA_SELECT_ACREDITACIONVEHICULARCTTA]
(
@EMPRESA  NVARCHAR(10) = NULL,
@DIVISION  NVARCHAR(10) = NULL
) AS
BEGIN
	--SELECT T.PATENTE,
	--	CONVERT(NVARCHAR(9),T.TIPO) AS TIPO,
	--	T.MARCA,
	--	T.MODELO,
	--	[dbo].[fn_cert_veh2] (T.PATENTE , @EMPRESA , T.TIPO , @DIVISION , dbo.hoy(getdate())) AS CERTV
	--INTO #TEMP
	--FROM TRANSPORT AS T
	--INNER JOIN TRANSPORT_DIVISION AS TD ON TD.PATENTE = T.PATENTE
	--WHERE T.EMPRESA = @EMPRESA
	--AND TD.DIVISION = @DIVISION

	--SELECT * FROM #TEMP WHERE CERTV = 1

	CREATE TABLE #PATENTES (
	 PATENTE	VARCHAR(8)		  COLLATE DATABASE_DEFAULT NOT NULL,
	 MARCA		NVARCHAR(50)	  COLLATE DATABASE_DEFAULT NOT NULL,
	 MODELO		NVARCHAR(50) 	  COLLATE DATABASE_DEFAULT NOT NULL
	);

	DECLARE @PATENTE NVARCHAR(8)  
	DECLARE @TIPO INT
	DECLARE @MARCA NVARCHAR(50)
	DECLARE @MODELO NVARCHAR(50)

	DECLARE PATENTE_CURSOR CURSOR  
	FOR
		SELECT
			PATENTE,
			CONVERT(NVARCHAR(9),TIPO) AS TIPO,
			MARCA,
			MODELO
		FROM TRANSPORT
		WHERE
			EMPRESA = @EMPRESA
 
	OPEN PATENTE_CURSOR 
 
	FETCH NEXT FROM PATENTE_CURSOR INTO @PATENTE,@TIPO, @MARCA , @MODELO
 
	WHILE @@FETCH_STATUS = 0 
		BEGIN
		
		DECLARE @ID_DOC INT
		DECLARE @SUBEDOC NVARCHAR(2) 
		DECLARE @Continuar BIT
		SET @Continuar = 1
		

		DECLARE DOCS_CURSOR CURSOR  
		FOR
			SELECT
				D.ID_DOC,
				ISNULL(D.SUBEDOC,'NO') AS SUBEDOC 
			FROM DOCS D
			WHERE
				D.ID_TIPO_PROPIETARIO = 3 AND
				D.ACTIVO = 'SI' AND
				D.ID_DOC_OPCION = 1 AND
				D.ID_DOC IN
						(
						  SELECT
							DISTINCT ID_DOC
						  FROM DOCS_TIPOPASE
						  WHERE
							TIPOPASE = CAST(@TIPO AS NVARCHAR) AND
							(DIVISION IN(@DIVISION,'AA'))
						) AND
				D.ID_DOC <> '103'
 
		OPEN DOCS_CURSOR 
 
		FETCH NEXT FROM DOCS_CURSOR INTO @ID_DOC,@SUBEDOC
 
		WHILE @@FETCH_STATUS = 0 
			BEGIN
				
				DECLARE @DOCVALIDADO NVARCHAR(2) = NULL
				SELECT
					TOP 1
					@DOCVALIDADO = ISNULL(VALIDADO,'NO') 
				FROM DOCS_TRANSPORT DT 
				INNER JOIN DOCS D
					ON DT.ID_DOC = D.ID_DOC 
				WHERE
					(PATENTE = @PATENTE) AND 
					((DIVISION IN(@DIVISION)) OR (ISNULL(DIVISION, 'AA') = 'AA')) AND 
					(DT.ID_DOC = @ID_DOC) AND 
					(EMPRESA = (CASE WHEN D.COMUN=1 THEN EMPRESA ELSE @EMPRESA END))
				ORDER BY ID_DOCS_VEH DESC

				IF @DOCVALIDADO IS NOT NULL
					BEGIN		
						IF @DOCVALIDADO <> 'SI'
							BEGIN
								SET @Continuar = 0
								BREAK
							END
					END
				ELSE
					BEGIN
						IF @SUBEDOC <> 'NO' 
						BEGIN
							SET @Continuar = 0
							BREAK
						END
					END

				DECLARE @FECHAVALIDADA INT = 0
				EXEC [V4MVC_DOCS_FEC_VALIDAFECHAS_VEHICULOS] @ID_DOC,@PATENTE,@EMPRESA,@DIVISION,@FECHAVALIDADA OUTPUT

				IF @FECHAVALIDADA = 0
					BEGIN
						SET @Continuar = 0
						BREAK
					END
					
				FETCH NEXT FROM DOCS_CURSOR INTO @ID_DOC,@SUBEDOC 
 
			END

		CLOSE DOCS_CURSOR  
		DEALLOCATE DOCS_CURSOR 

			--CURSOR 2

		IF @Continuar = 1
			BEGIN
				INSERT INTO #PATENTES
				SELECT @PATENTE,@MARCA,@MODELO
			END

		FETCH NEXT FROM PATENTE_CURSOR INTO @PATENTE,@TIPO ,@MARCA,@MODELO
 
	END

	CLOSE PATENTE_CURSOR  
	DEALLOCATE PATENTE_CURSOR 

	SELECT * FROM #PATENTES

END