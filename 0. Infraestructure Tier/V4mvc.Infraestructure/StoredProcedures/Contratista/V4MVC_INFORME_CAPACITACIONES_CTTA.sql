CREATE PROCEDURE [dbo].[V4MVC_INFORME_CAPACITACIONES_CTTA]
(
 @DIVCOD	NVARCHAR(4)		= NULL
,@FECHAINI	NVARCHAR(8)		= NULL
,@FECHAFIN	NVARCHAR(8)		= NULL
,@IDCHARLA	INT				= NULL
,@EMPRESA	NVARCHAR(10)	= NULL
,@RUT		NVARCHAR(10)	= NULL
)
AS
BEGIN

	IF(@IDCHARLA = 0)
	BEGIN
		SET @IDCHARLA = NULL
	END

	SELECT DISTINCT		COUNT(DISTINCT CR.RUT) AS PARTICIPANTES		,D.DIVISION		,D.DIVCOD		,CP.CODIGO
						,CH.CHARLA									,CP.FECHA		,CP.HORA		,CP.FINALIZADO
						,COUNT(CASE WHEN CR.NOTA>=CH.PORCENTAJE THEN 1 ELSE null END) AS CUENTASI
						,COUNT(CASE WHEN CR.NOTA<CH.PORCENTAJE  THEN 1 ELSE null END) AS CUENTANO 
	FROM A036_CURSORESERVA			AS CR
	INNER JOIN A036_CURSOPROG		AS CP ON CR.CODIGO = CP.CODIGO
	INNER JOIN CHARLAS				AS CH ON CP.CURSO = CH.IDCHARLA
	INNER JOIN CHARLAS_DIVISION		AS CHD ON CH.IDCHARLA = CHD.IDCHARLA
	INNER JOIN A024_DIVISIONES		AS D ON CHD.DIVISION = D.DIVCOD 
	INNER JOIN ENTERPRISE			AS E ON CR.EMPRESA = E.IDEMPRESA WHERE 1 = 1
	AND E.IDEMPRESA					=		@EMPRESA
	AND D.DIVCOD					=		@DIVCOD
	AND CP.FECHA	BETWEEN ISNULL(@FECHAINI,CP.FECHA) AND ISNULL(@FECHAFIN,CP.FECHA)
	AND CH.IDCHARLA					=		ISNULL(@IDCHARLA,CH.IDCHARLA)
	AND CR.RUT						=		ISNULL(@RUT, CR.RUT)
	AND ASISTIO						=		'SI' 
	GROUP BY D.DIVISION,D.DIVCOD, CP.CODIGO, CH.CHARLA, CP.FECHA, CP.HORA, CP.FINALIZADO
	ORDER BY CP.FECHA, CP.HORA ASC 

END


--EXEC V4MVC_INFORME_CAPACITACIONES_CTTA 'LB',null,null,NULL,'761264907',NULL
