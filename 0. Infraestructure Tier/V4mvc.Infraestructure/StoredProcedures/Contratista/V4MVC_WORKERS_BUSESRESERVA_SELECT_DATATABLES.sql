CREATE PROCEDURE [dbo].[V4MVC_WORKERS_BUSESRESERVA_SELECT_DATATABLES]                
(             
@IDISPLAYSTART INT,              
@IDISPLAYLENGTH INT,              
@SEARCH_RUT NVARCHAR(10) = NULL,        
@SEARCH_NOMBRES NVARCHAR(50) = NULL,        
@SEARCH_APELLIDOS NVARCHAR(50) = NULL,     
@SEARCH_EMPRESA NVARCHAR(50) = NULL,
@SEARCH_OST NVARCHAR(14) = NULL,
@SEARCH_IDEMPRESA NVARCHAR(10) = NULL,
@SORT_COLUMN NVARCHAR(4) = NULL,        
@SORT_DIRECTION NVARCHAR(4) = NULL        
) AS                
BEGIN            
	DECLARE @QUERY NVARCHAR(MAX)
	SET @QUERY  = 'SELECT DISTINCT W.RUT,W.NOMBRES,W.APELLIDOS,E.ACRONIMO AS EMPRESA,WL.OST AS OST,W.RUT+''-''+WL.OST AS SELECTED, COUNT(W.RUT) OVER() COUNT_WORKERS                           
	FROM WORKERS AS W
	INNER JOIN WORKERSLOCAL AS WL ON WL.RUT = W.RUT
	INNER JOIN ENTERPRISE AS E ON E.IDEMPRESA = WL.EMPRESA WHERE WL.AUTOR = ''SI'' 
    AND WL.VALIDADO = ''SI'' 
	AND WL.EMPRESA = '''+@SEARCH_IDEMPRESA+'''
	AND ((CONVERT(VARCHAR(8),GETDATE(),112) BETWEEN WL.FINIPASE AND WL.FFINPASE) OR (WL.FINIPASE BETWEEN CONVERT(VARCHAR(8),GETDATE(),112) AND CONVERT(VARCHAR(8), DATEADD(d,45,GETDATE()),112))) '

	IF @SEARCH_RUT IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND W.RUT LIKE ' + '''%' + @SEARCH_RUT + '%''' END
	IF @SEARCH_NOMBRES IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND W.NOMBRES LIKE ' + '''%' + @SEARCH_NOMBRES + '%''' END
	IF @SEARCH_APELLIDOS IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND W.APELLIDOS LIKE ' + '''%' + @SEARCH_APELLIDOS + '%''' END
	IF @SEARCH_EMPRESA IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND E.ACRONIMO LIKE ' + '''%' + @SEARCH_EMPRESA + '%''' END
	IF @SEARCH_OST IS NOT NULL BEGIN SET @QUERY = @QUERY + ' AND W.OST LIKE ' + '''%' + @SEARCH_OST + '%''' END

	    
   IF @SORT_COLUMN='0' BEGIN SET @QUERY = @QUERY + ' ORDER BY RUT ' +  @SORT_DIRECTION END   
   IF @SORT_COLUMN='1' BEGIN SET @QUERY = @QUERY + ' ORDER BY NOMBRES ' + @SORT_DIRECTION END   
   IF @SORT_COLUMN='2' BEGIN SET @QUERY = @QUERY + ' ORDER BY APELLIDOS '  + @SORT_DIRECTION END 
   IF @SORT_COLUMN='3' BEGIN SET @QUERY = @QUERY + ' ORDER BY ACRONIMO ' + @SORT_DIRECTION END
   IF @SORT_COLUMN='4' BEGIN SET @QUERY = @QUERY + ' ORDER BY OST ' + @SORT_DIRECTION END

   SET @QUERY = @QUERY + ' OFFSET ' + CAST(@IDISPLAYSTART AS VARCHAR) + ' ROWS FETCH NEXT ' + CAST(@IDISPLAYLENGTH AS VARCHAR) + ' ROWS ONLY'

	--PRINT(@QUERY)
	EXEC(@QUERY)
  
END   
