CREATE PROCEDURE [dbo].[V4MVC_SET_WORKER_DATOS]
(
@RUT			NVARCHAR(8) = NULL
,@IDEMPRESA			NVARCHAR(10) = NULL
,@FECHA_FINIQ		NVARCHAR(8) = NULL
,@USUARIO			NVARCHAR(20) = NULL
,@DIVCOD			NVARCHAR(10) = NULL
,@ARCHIVO			UNIQUEIDENTIFIER = NULL
,@OBSERVACION		NVARCHAR(500) = NULL
)
AS
BEGIN
	DECLARE @FECHA_INGRESO NVARCHAR(8) = ''
	DECLARE @CURR_FECHA NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 112) /* yyyymmdd */
	DECLARE @CURR_TIEMPOFULL NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 108) /* hh:mm:ss */
	DECLARE @OST NVARCHAR(14) = ''
	IF(@FECHA_FINIQ <> '')
		BEGIN
			SELECT TOP 1 @FECHA_INGRESO = FINIPASE  
			FROM WORKERSLOCAL
			WHERE  (RUT = @RUT) AND (EMPRESA = @IDEMPRESA) AND (DIVISION = @DIVCOD) AND (FFINPASE >= @CURR_FECHA) AND (AUTOR IN ('SI','NO'))
			ORDER BY FINIPASE ASC
	
			IF (EXISTS
				(
					SELECT *
					FROM WORKERSDATOS
					WHERE (RUT = @RUT) AND (EMPRESA = @IDEMPRESA) AND (FINGRESO = @FECHA_INGRESO)
				))
				BEGIN
					UPDATE WORKERSDATOS SET FINIQUITO = @FECHA_FINIQ, OBSERVACION = @OBSERVACION 
						WHERE RUT = @RUT AND EMPRESA = @IDEMPRESA AND  FINGRESO = @FECHA_INGRESO
				END
			ELSE
				BEGIN
					INSERT INTO WORKERSDATOS(RUT, EMPRESA, FINGRESO, FINIQUITO, OBSERVACION)
						VALUES(@RUT, @IDEMPRESA, @FECHA_INGRESO, @FECHA_FINIQ, @OBSERVACION) 
				END
			/*---------------------------------*/
			DECLARE getOST CURSOR FOR
			SELECT OST
			FROM WORKERSLOCAL
			WHERE RUT = @RUT AND EMPRESA = @IDEMPRESA AND DIVISION = @DIVCOD AND FFINPASE >= @CURR_FECHA AND AUTOR IN ('SI','NO')

			OPEN getOST
			FETCH NEXT
			FROM getOST INTO @OST
			WHILE @@FETCH_STATUS = 0
				BEGIN
					INSERT INTO WORKERSDATOS_HST(RUT, EMPRESA, FINGRESO, DIVISION, IDARCHIVO, AFP, ISAPRE, ECIVIL, SANGRE, RESTRIC, DESTINO, PASAJES, FINIQUITO, MOTIVO, OBSERVACION, USRREGISTRA, FECHAREGISTRA, HORAREGISTRA, USRMOD, FECHAMOD, HORAMOD, OST)
						SELECT RUT, EMPRESA, FINGRESO, @DIVCOD, @ARCHIVO, AFP, ISAPRE, ECIVIL, SANGRE, RESTRIC, DESTINO, PASAJES, FINIQUITO, MOTIVO, OBSERVACION, @USUARIO, @CURR_FECHA, @CURR_TIEMPOFULL, @USUARIO, @CURR_FECHA, @CURR_TIEMPOFULL, @OST
						FROM WORKERSDATOS WHERE RUT = @RUT AND EMPRESA = @IDEMPRESA AND  FINGRESO = @FECHA_INGRESO
					FETCH NEXT
					FROM getOST INTO @OST
				END

			CLOSE getOST
			DEALLOCATE getOST
		END

END
