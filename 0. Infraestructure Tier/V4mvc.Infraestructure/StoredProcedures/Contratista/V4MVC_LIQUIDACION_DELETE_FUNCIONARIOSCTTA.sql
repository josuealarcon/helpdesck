CREATE PROCEDURE [dbo].[V4MVC_LIQUIDACION_DELETE_FUNCIONARIOSCTTA]
(@RUT	  NVARCHAR(10) = NULL
,@FECHA	  NVARCHAR(6) = NULL
,@EMPRESA	  NVARCHAR(10) = NULL
,@ID_DISPUTA INT = NULL
,@USUARIO NVARCHAR(10) = NULL) AS
BEGIN
DECLARE @VALIDADO VARCHAR(2)
BEGIN TRAN

		 INSERT INTO LIQUIDACION_LOG (RUT, FECHA, NOMBRE_ARCHIVO, TIPO_CONTENIDO,ARCHIVO, FECHASUBE, HORASUBE, USUARIO, VALIDADO, CERTUSUARIO, CERTFECHA, CERTHORA,IDRECHAZO, ID, IMPONIBLE, LIQUIDO, TRANSFERIDO, EMPRESA, BONOIP, BONOIS, FECHACSV, HORACSV, USUARIOCSV, USUARIODEL, FECHADEL, HORADEL)
						 SELECT TOP 1 RUT, FECHA, NOMBRE_ARCHIVO, TIPO_CONTENIDO, ARCHIVO, FECHASUBE, HORASUBE, USUARIO, VALIDADO, CERTUSUARIO, CERTFECHA, CERTHORA, IDRECHAZO, ID, IMPONIBLE, LIQUIDO, TRANSFERIDO, EMPRESA, BONOIP, BONOIS, FECHACSV, HORACSV, USUARIOCSV, @USUARIO,[dbo].[hoy](GETDATE()), [dbo].[ahora](GETDATE())
						 FROM LIQUIDACION 
						 WHERE RUT = @RUT AND FECHA = @FECHA AND EMPRESA = @EMPRESA
	IF @ID_DISPUTA<>0
	BEGIN
		 INSERT INTO LIQUIDACION_DISPUTA_LOG (ID_DISPUTA , RUT , PERIODO , EMPRESA , ID , USUARIO , FECHA , HORA , OBSERVACION , CERTUSUARIO , CERTFECHA , CERTHORA , VALIDADO , ESTADO , REVALUSUARIO , REVALFECHA , REVALHORA , OBSERVACION_REVAL, USRMOD, FECHAMOD, HORAMOD, ACCION )
									  SELECT  ID_DISPUTA , RUT , PERIODO , EMPRESA , ID , USUARIO , FECHA , HORA , OBSERVACION , CERTUSUARIO , CERTFECHA , CERTHORA , VALIDADO , ESTADO , REVALUSUARIO , REVALFECHA , REVALHORA , OBSERVACION_REVAL, @USUARIO,[dbo].[hoy](GETDATE()), [dbo].[ahora](GETDATE()), 'ELIMINADO' 
									  FROM LIQUIDACION_DISPUTA 
									  WHERE ID_DISPUTA = @ID_DISPUTA AND ESTADO = 'NO'
         DELETE LIQUIDACION_DISPUTA WHERE ID_DISPUTA = @ID_DISPUTA AND ESTADO = 'NO' 
	END


COMMIT TRAN
 SET @VALIDADO = 'SI'
TratarError:
If @@Error<>0 
BEGIN
 SET @VALIDADO = 'NO'
 ROLLBACK TRAN
END		
SELECT @VALIDADO VALIDADO

END
