CREATE PROCEDURE [dbo].[V4MVC_OST_SELECT_PASES_CTTA]
(
  @DIVISION				NVARCHAR(10)
 ,@IDEMPRESA			NVARCHAR(10)
 ,@OST_UNICA			NVARCHAR(14) OUTPUT
 ,@CUENTA_CONTR			INT OUTPUT
 ,@FECINICIO			NVARCHAR(8) OUTPUT
 ,@FECTERM				NVARCHAR(8) OUTPUT
 ,@ESPOR				NVARCHAR(2) OUTPUT
 ,@PERIODOS				NVARCHAR(MAX) OUTPUT
) AS
BEGIN
	DECLARE @CURR_FECHA NVARCHAR(8) = convert(NVARCHAR(8), getdate(), 112) /* yyyymmdd */
	DECLARE @CONTR_OST NVARCHAR(14)
	DECLARE @CONTR_FECINICIO NVARCHAR(8)
	DECLARE @CONTR_FECTERM NVARCHAR(8)
	DECLARE @CONTR_FFINCERT NVARCHAR(8)
	DECLARE @CONTR_ESPORADICO NVARCHAR(2)
	DECLARE @CONTR_DESCRIPOST NVARCHAR(100)
	DECLARE @PERIODO_FECHAINICIO NVARCHAR(8)
	DECLARE @PERIODO_FECHAFIN NVARCHAR(8)
	DECLARE @FRMT_DESCRIPOST NVARCHAR(50)
	DECLARE @OST2 NVARCHAR(14)
	DECLARE @OST3 NVARCHAR(14)

	CREATE TABLE #SET_OST(
		NROOST				NVARCHAR(14)	 COLLATE DATABASE_DEFAULT NOT NULL,   
		FECINICIO			NVARCHAR(8)		 COLLATE DATABASE_DEFAULT NOT NULL,   
		FECTERM				NVARCHAR(8)		 COLLATE DATABASE_DEFAULT NOT NULL,   
		ESPORADICO			NVARCHAR(2)		 COLLATE DATABASE_DEFAULT NOT NULL,   
		PERIODOS			NVARCHAR(MAX)	 COLLATE DATABASE_DEFAULT NOT NULL,   
		OST2				NVARCHAR(14)	 COLLATE DATABASE_DEFAULT NOT NULL,   
		OST3				NVARCHAR(14)	 COLLATE DATABASE_DEFAULT NOT NULL,   
		DESCRIPOST			NVARCHAR(55)	 COLLATE DATABASE_DEFAULT NOT NULL
		)

	SET @CUENTA_CONTR = -1
	SET @OST_UNICA = ''
	SET @PERIODOS = ''

	SELECT
		@CUENTA_CONTR = COUNT(DISTINCT DL.OST)
	FROM OSTDIVLOCAL DL
	INNER JOIN OST AS O
		ON DL.OST = O.NROOST
	INNER JOIN OSTSUBC OSC
		ON DL.OST = OSC.OST
	WHERE
		(DL.DIVISION = @DIVISION) AND
		(O.FECTERM >= @CURR_FECHA) AND
		(OSC.FTERMINO >= @CURR_FECHA) AND
		(DL.ACTIVO = 'SI') AND
		(OSC.EMPRESA = @IDEMPRESA)
	IF(@CUENTA_CONTR > 0)
		BEGIN

			DECLARE getContratos CURSOR FOR
			SELECT
				DISTINCT
					OSC.FFINCERT,
					DL.OST,
					OSC.FINICIO AS FECINICIO,
					OSC.FTERMINO AS FECTERM,
					OSC.DESCRIPOST,
					OSC.ESPORADICO
				FROM OSTDIVLOCAL AS DL
				INNER JOIN dbo.OSTSUBC_V2 AS OSC
					ON DL.OST = OSC.OST AND ((DL.EMPRESA = OSC.EMPRESA) OR (DL.EMPRESA = OSC.MADRE))
				WHERE (DL.DIVISION = @DIVISION) AND
						(OSC.FTERMINO >= @CURR_FECHA) AND
						(DL.ACTIVO = 'SI') AND
						(OSC.EMPRESA = @IDEMPRESA)
				ORDER BY DL.OST DESC

			OPEN getContratos
			FETCH NEXT
			FROM getContratos INTO @CONTR_FFINCERT, @CONTR_OST, @CONTR_FECINICIO, @CONTR_FECTERM, @CONTR_DESCRIPOST, @CONTR_ESPORADICO  
			WHILE @@FETCH_STATUS = 0
				BEGIN
					IF(@CUENTA_CONTR = 1 AND @OST_UNICA = '')
						BEGIN
							SET @OST_UNICA = LTRIM(RTRIM(@CONTR_OST))
						END
					IF(@CONTR_ESPORADICO = 'SI')
						BEGIN
							
							DECLARE getPeriodoEsp CURSOR FOR
							SELECT
								FECHAINICIO,
								FECHAFIN
							FROM OST_ESPORADICO
							WHERE FECHAFIN >= @CURR_FECHA AND OST = @CONTR_OST
							ORDER BY FECHAINICIO

							SET @PERIODOS = ''

							OPEN getPeriodoEsp
							FETCH NEXT
							FROM getPeriodoEsp INTO @PERIODO_FECHAINICIO, @PERIODO_FECHAFIN
							
							WHILE @@FETCH_STATUS = 0
								BEGIN
									SET @PERIODOS = CONCAT(@PERIODOS, ISNULL(@PERIODO_FECHAINICIO, ''), '|', ISNULL(@PERIODO_FECHAFIN, ''), '*' )

									FETCH NEXT
									FROM getPeriodoEsp INTO @PERIODO_FECHAINICIO, @PERIODO_FECHAFIN									
								END

							CLOSE getPeriodoEsp
							DEALLOCATE getPeriodoEsp

						END
						
						IF(@FRMT_DESCRIPOST IS NOT NULL AND LEN(@FRMT_DESCRIPOST) > 50)
							BEGIN
								SET @FRMT_DESCRIPOST = LEFT(@CONTR_DESCRIPOST, 50) + '...'
							END
						ELSE
							BEGIN
								SET @FRMT_DESCRIPOST = @CONTR_DESCRIPOST
							END

						SET @OST2 = REPLACE(LTRIM(RTRIM(@CONTR_OST)), ' ', '')
						SET @OST3 = LTRIM(RTRIM(@CONTR_OST))

						INSERT INTO #SET_OST(
							NROOST,
							FECINICIO,
							FECTERM,
							ESPORADICO,
							PERIODOS,
							OST2,
							OST3,
							DESCRIPOST)
						VALUES(@CONTR_OST, @CONTR_FECINICIO, @CONTR_FECTERM, @CONTR_ESPORADICO, @PERIODOS, @OST2, @OST3, @FRMT_DESCRIPOST)
					
					FETCH NEXT
					FROM getContratos INTO @CONTR_FFINCERT, @CONTR_OST, @CONTR_FECINICIO, @CONTR_FECTERM, @CONTR_DESCRIPOST, @CONTR_ESPORADICO

				END

			CLOSE getContratos
			DEALLOCATE getContratos			
			
			SET @FECINICIO = @CONTR_FECINICIO
			SET @FECTERM = @CONTR_FECTERM
			SET @ESPOR = @CONTR_ESPORADICO
					
		END

		SELECT *
		FROM #SET_OST
END

