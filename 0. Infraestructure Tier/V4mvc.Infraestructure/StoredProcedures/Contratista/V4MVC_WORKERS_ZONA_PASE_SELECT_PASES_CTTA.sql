CREATE PROCEDURE [dbo].[V4MVC_WORKERS_ZONA_PASE_SELECT_PASES_CTTA]
(
   @RUT			    NVARCHAR(10)
  ,@DIVCOD          NVARCHAR(10)
  ,@ID_PASE			INT
  ,@IDEMPRESA		NVARCHAR(10)
) AS 
BEGIN
	DECLARE @EXISTE_FUNC BIT = 0
	DECLARE @LOCAL NVARCHAR(12) = ''
	DECLARE @ESTADO NVARCHAR(2) = ''
	DECLARE @DETALLE NVARCHAR(50) = ''
	DECLARE @CCHECKED BIT = 0
	DECLARE @CDISABLED BIT = 0

	IF(EXISTS(
		SELECT *
		FROM WORKERS_ZONA_PASE
		WHERE
			(LOTENUM = @ID_PASE) AND
			(RUT = @RUT) AND
			(EMPRESA = @IDEMPRESA)
	))
		BEGIN
			SET @EXISTE_FUNC = 1
		END

	SELECT
		TOP 1
		@ESTADO = LOTEESTADO
	FROM LOTEPASES
	WHERE LOTENUM = @ID_PASE

	CREATE TABLE #ZONAS_CONDUCCION (
		LOCAL		NVARCHAR(12)	 COLLATE DATABASE_DEFAULT NOT NULL, 
		DETALLE		NVARCHAR(50)	 COLLATE DATABASE_DEFAULT NOT NULL, 
		CHECKED		BIT,
		DISABLED	BIT
	)

	DECLARE cursor_loc CURSOR
	FOR
		SELECT L.LOCAL, L.DETALLE
		FROM LOCAL L
		WHERE
			(L.LOCALL = 'ACCESO') AND
			(L.ACTIVO = 'SI') AND
			(L.DIVISION = @DIVCOD)
		ORDER BY LOCAL

	OPEN cursor_loc

	FETCH NEXT FROM cursor_loc INTO 
		@LOCAL, @DETALLE

	WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @CCHECKED = 0
			SET @CDISABLED = 0

			IF(@EXISTE_FUNC = 1)
				BEGIN
					IF(@LOCAL IS NOT NULL AND @LOCAL <> '' AND @RUT IS NOT NULL AND @RUT <> '')
						BEGIN
							IF(EXISTS(
								SELECT *
								FROM WORKERS_ZONA_PASE WZP
								WHERE
									(WZP.LOTENUM = @ID_PASE) AND
									(WZP.RUT = @RUT) AND
									(WZP.EMPRESA = @IDEMPRESA) AND
									(WZP.LOCAL = @LOCAL)
							))
								BEGIN
									SET @CCHECKED = 1
								END
						END
				END
			ELSE
				BEGIN
					IF(@LOCAL IS NOT NULL AND @LOCAL <> '' AND @RUT IS NOT NULL AND @RUT <> '')
						BEGIN
							IF(EXISTS(
								SELECT *
								FROM WORKERS_ZONA_AUT WZA
								WHERE
									(WZA.RUT = @RUT) AND
									(WZA.EMPRESA = @IDEMPRESA) AND
									(WZA.LOCAL = @LOCAL) AND
									(WZA.ACTIVO = 'SI')
							))
								BEGIN
									SET @CCHECKED = 1
								END
						END
				END

			IF(@ESTADO = 'SI' OR @ESTADO = 'RE' )
				BEGIN
					SET @CDISABLED = 1
				END

			IF(@CCHECKED = 1 OR @CDISABLED = 1)
				BEGIN
					INSERT INTO #ZONAS_CONDUCCION(LOCAL, DETALLE, CHECKED, DISABLED)
					VALUES(@LOCAL, @DETALLE, @CCHECKED, @CDISABLED)
				END
			
			FETCH NEXT FROM cursor_loc INTO 
				@LOCAL,@DETALLE
		END

	CLOSE cursor_loc

	DEALLOCATE cursor_loc

	SELECT
		LOCAL,
		DETALLE,
		CHECKED,
		DISABLED
	FROM #ZONAS_CONDUCCION

END


