CREATE PROCEDURE [dbo].[V4MVC_POLIZAS_DELETE_EDITAR_DATATABLE_POLIZAS_CTTA]
(
  @IDDOC INT               = NULL
, @NROPOLIZA NVARCHAR(50)  = NULL
, @USUARIOMOD NVARCHAR(10) = NULL
) 
AS
BEGIN

	--ELIMINA PAGO
	INSERT INTO POLIZAS_PAGO_DEL (NROPOLIZA			,IDDOC					,PERINI						,PERFIN
								 ,IDPAGO			,VALIDADO				,CERTFECHA					,CERTHORA
								 ,CERTUSUARIO		, OBSERVACION			,USUARIOMOD					,FECHAMOD
								 ,HORAMOD			,FECHADEL				,HORADEL					,USUARIODEL) 
						   SELECT NROPOLIZA			,IDDOC					,PERINI						,PERFIN
								 ,IDPAGO			,VALIDADO				,CERTFECHA					,CERTHORA
								 ,CERTUSUARIO		,OBSERVACION			,USUARIOMOD					,FECHAMOD
								 ,HORAMOD			,[dbo].[hoy](GETDATE())	,[dbo].[ahora](GETDATE())	,@USUARIOMOD 
						   FROM POLIZAS_PAGO WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA

	DELETE FROM POLIZAS_PAGO WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA
	
	--ELIMINA NOMINA
	INSERT INTO POLIZAS_NOMINA_DEL(RUT				,NROPOLIZA				,IDDOC				,VALIDADO)
	                        SELECT RUT				,NROPOLIZA				,IDDOC				,VALIDADO 
	FROM POLIZAS_NOMINA WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA
	DELETE FROM POLIZAS_NOMINA WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA

	--ELIMINA POLIZA
	INSERT INTO POLIZAS_DEL (NROPOLIZA					,IDDOC				,FECINI				,FECFIN
	                        ,EMPRESA					,DIVISION			,ID					,VALIDADO			
							,CERTFECHA					,CERTHORA			,CERTUSUARIO		,OBSERVACION		
							,USUARIOMOD					,FECHAMOD			,HORAMOD			,FECHADEL			
							,HORADEL					,USUARIODEL			,OST) 
                      SELECT NROPOLIZA					,IDDOC				,FECINI				,FECFIN
							,EMPRESA					,DIVISION			,ID					,VALIDADO
							,CERTFECHA					,CERTHORA			,CERTUSUARIO		,OBSERVACION
							,USUARIOMOD					,FECHAMOD			,HORAMOD			,[dbo].[hoy](GETDATE())
							,[dbo].[ahora](GETDATE())	,@USUARIOMOD		,OST 
							FROM POLIZAS WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA
	DELETE FROM POLIZAS WHERE IDDOC=@IDDOC AND NROPOLIZA=@NROPOLIZA 

END

